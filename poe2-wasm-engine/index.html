<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POE2 WASM Engine - Crafting Simulator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0d0d0d;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #242424;
      --border: #333333;
      --border-light: #404040;
      --text-primary: #e8e8e8;
      --text-secondary: #b8b8b8;
      --text-muted: #808080;
      --accent: #ff8c42;
      --accent-hover: #ffa05c;
      --accent-dark: #e67a32;
      --success: #4ade80;
      --error: #f87171;
      --magic: #6495ed;
      --rare: #ffd700;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      height: 100vh;
      overflow: hidden;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* Header */
    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logo h1 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.5px;
    }
    
    .beta-badge {
      font-size: 0.65rem;
      color: var(--accent);
      background: rgba(255, 140, 66, 0.15);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-weight: 600;
      border: 1px solid rgba(255, 140, 66, 0.3);
    }
    
    .header-links {
      display: flex;
      gap: 0.5rem;
    }
    
    .header-link {
      padding: 0.4rem 0.75rem;
      font-size: 0.75rem;
      border-radius: 6px;
      text-decoration: none;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .header-link:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.1);
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr 400px;
      gap: 1rem;
      padding: 1rem;
      overflow: hidden;
    }
    
    /* Panels */
    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    
    .panel-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .panel-step {
      font-size: 0.7rem;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
    }
    
    .panel-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .panel-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .panel-content::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }
    
    .panel-content::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }
    
    .panel-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    
    /* Item Selection */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5rem;
    }
    
    .item-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .item-box:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }
    
    .item-box.selected {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.15);
      color: var(--accent);
    }
    
    /* Mode & Rarity Selection */
    .selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .selection-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .selection-box:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    
    .selection-box.magic { border-color: var(--magic); }
    .selection-box.rare { border-color: var(--rare); }
    
    .selection-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .selection-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }
    
    .selection-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    
    .selection-box.magic .selection-title { color: var(--magic); }
    .selection-box.rare .selection-title { color: var(--rare); }
    
    /* Selection Summary */
    .selection-summary {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    
    .summary-label {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    
    .summary-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: rgba(255, 140, 66, 0.15);
      color: var(--accent);
      border: 1px solid rgba(255, 140, 66, 0.3);
    }
    
    .summary-badge.magic {
      background: rgba(100, 149, 237, 0.15);
      color: var(--magic);
      border-color: rgba(100, 149, 237, 0.3);
    }
    
    .summary-badge.rare {
      background: rgba(255, 215, 0, 0.15);
      color: var(--rare);
      border-color: rgba(255, 215, 0, 0.3);
    }
    
    .summary-badge.normal {
      background: rgba(200, 200, 200, 0.15);
      color: var(--text-secondary);
      border-color: rgba(200, 200, 200, 0.3);
    }
    
    .summary-badge.clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .summary-badge.clickable:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .summary-badge.magic.clickable:hover {
      background: rgba(100, 149, 237, 0.25);
      border-color: var(--magic);
    }
    
    .summary-badge.rare.clickable:hover {
      background: rgba(255, 215, 0, 0.25);
      border-color: var(--rare);
    }
    
    .summary-badge.normal.clickable:hover {
      background: rgba(200, 200, 200, 0.25);
      border-color: var(--text-secondary);
    }
    
    .change-btn {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }
    
    .change-btn:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.1);
    }
    
    /* Modifier Selection */
    .mod-filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .mod-filter-group {
      flex: 1;
    }
    
    .mod-filter-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .mod-source {
      margin-bottom: 0.75rem;
    }
    
    .mod-source select,
    .mod-filter-group select {
      width: 100%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    
    .mod-source select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .mod-lists {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .mod-group-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .mod-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
    }
    
    .modifier-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modifier-item:hover {
      border-color: var(--accent);
    }
    
    .modifier-item.selected {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.1);
    }
    
    .modifier-item input[type="checkbox"] {
      display: none;
    }
    
    .modifier-item label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      cursor: pointer;
      display: block;
      margin-bottom: 0.25rem;
      word-wrap: break-word;
    }
    
    .modifier-item.selected label {
      color: var(--accent);
    }
    
    .tier-badge {
      display: inline-block;
      font-size: 0.6rem;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
    }
    
    .source-badge {
      display: inline-block;
      font-size: 0.6rem;
      font-weight: 600;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      margin-left: 0.25rem;
    }
    
    .source-badge.normal-source {
      background: rgba(184, 184, 184, 0.2);
      color: var(--text-secondary);
    }
    
    .source-badge.desecrated-source {
      background: rgba(139, 69, 255, 0.2);
      color: #b89fff;
    }
    
    .source-badge.essence-source {
      background: rgba(74, 222, 128, 0.2);
      color: var(--success);
    }
    
    .tier-dropdown {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.25rem;
      border-radius: 4px;
      font-size: 0.65rem;
      margin-top: 0.375rem;
    }
    
    .tier-dropdown:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Selected Modifiers Panel */
    .selected-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }
    
    .selected-info {
      flex: 1;
    }
    
    .selected-mode {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    
    .selected-rarity {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .selected-rarity.magic { color: var(--magic); }
    .selected-rarity.rare { color: var(--rare); }
    
    .selected-count {
      font-size: 0.7rem;
      color: var(--accent);
      background: rgba(255, 140, 66, 0.15);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .selected-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .selected-group-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    
    .selected-mod {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
    }
    
    .selected-mod-desc {
      font-size: 0.75rem;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .selected-mod-tier {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    
    .tier-name {
      color: var(--accent);
      font-weight: 600;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    /* Status Bar */
    .status-bar {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 0.5rem 1.5rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-success { color: var(--success); }
    .status-warning { color: var(--accent); }
    
    @media (max-width: 1400px) {
      .main-content {
        grid-template-columns: 1fr 350px;
      }
      
      .header-links {
        display: none;
      }
    }
    
    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="logo">
        <h1>POE2HTC</h1>
        <span class="beta-badge">BETA</span>
      </div>
      <div class="header-links">
        <a href="https://discord.gg/RvxCWyFF3D" target="_blank" class="header-link">üí¨ Discord</a>
        <a href="https://github.com/Dboire9/POE2_HTC/issues/new" target="_blank" class="header-link">üêõ Bug</a>
        <a href="https://buymeacoffee.com/dboire" target="_blank" class="header-link">‚òï Support</a>
        <a href="https://github.com/Dboire9/POE2_HTC" target="_blank" class="header-link">‚≠ê GitHub</a>
      </div>
    </header>

    <div class="main-content">
      <!-- Left Panel: Item & Mode & Rarity -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Setup</span>
          <span class="panel-step">Steps 1-3</span>
        </div>
        <div class="panel-content">
          <!-- Item Selection -->
          <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Base Item</div>
            <div id="itemGrid" class="item-grid"></div>
            <div id="subtypeSection" style="display: none; margin-top: 0.75rem;">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;" id="subtypeLabel">Subtype</div>
              <div id="subtypeGrid" class="item-grid"></div>
            </div>
          </div>

          <!-- Mode & Rarity Selection -->
          <div id="modeRaritySection" style="display: none;">
            <!-- Selection Summary -->
            <div id="selectionSummary" style="display: none;">
              <div class="selection-summary">
                <span class="summary-label">Mode:</span>
                <span class="summary-badge" id="modeBadge"></span>
                <span class="summary-label" id="rarityLabelSummary" style="display: none;">Rarity:</span>
                <select id="rarityDropdownInline" onchange="onRarityChange()" style="display: none; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">
                  <option value="normal">Normal</option>
                  <option value="magic">Magic</option>
                  <option value="rare">Rare</option>
                </select>
                <button class="change-btn" onclick="changeSelection()">Change</button>
              </div>
            </div>
            
            <!-- Mode Selection Boxes -->
            <div id="modeSelectionBoxes">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Crafting Mode</div>
              <div class="selection-grid" style="margin-bottom: 1.5rem;">
                <div class="selection-box" onclick="selectMode('scratch')">
                  <div class="selection-title">From Scratch</div>
                  <div class="selection-desc">Start with blank item</div>
                </div>
                <div class="selection-box" onclick="selectMode('improve')">
                  <div class="selection-title">Improve</div>
                  <div class="selection-desc">Add/improve mods</div>
                </div>
              </div>
            </div>

            <!-- Rarity Selection -->
            <div id="raritySection" style="display: none;">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Item Rarity</div>
              <select id="rarityDropdown" onchange="selectRarity()" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.5rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                <option value="">Select rarity...</option>
                <option value="normal">Normal</option>
                <option value="magic">Magic</option>
                <option value="rare">Rare</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- Middle Panel: Modifiers -->
      <div class="panel" id="modifiersPanel" style="display: none;">
        <div class="panel-header">
          <span class="panel-title">Select Modifiers</span>
          <span class="panel-step">Step 4</span>
        </div>
        <div class="panel-content">
          <div id="stepDescription" style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
            Select the modifiers already on your item (0-2 max: 1 prefix and 1 suffix)
          </div>
          <div class="mod-filters">
            <div class="mod-filter-group">
              <div class="mod-filter-label">Source</div>
              <select id="modSource" onchange="reloadModifiers()">
                <option value="0">Normal</option>
                <option value="1">Desecrated</option>
                <option value="2">Essence</option>
                <option value="all" selected>All Sources</option>
              </select>
            </div>
            <div class="mod-filter-group">
              <div class="mod-filter-label">Type</div>
              <select id="modType" onchange="filterModifiers()">
                <option value="all">All Types</option>
                <option value="prefix">Prefixes Only</option>
                <option value="suffix">Suffixes Only</option>
              </select>
            </div>
          </div>

          <div class="mod-lists">
            <div>
              <div class="mod-group-title">Prefixes <span id="prefixCounter" style="color: #888;">(0/3)</span></div>
              <div id="prefixList" class="mod-grid"></div>
            </div>
            <div>
              <div class="mod-group-title">Suffixes <span id="suffixCounter" style="color: #888;">(0/3)</span></div>
              <div id="suffixList" class="mod-grid"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Selected Output -->
      <div class="panel" id="selectedPanel" style="display: none;">
        <div class="panel-header">
          <span class="panel-title">Selected</span>
        </div>
        <div class="panel-content">
          <div class="selected-header">
            <div class="selected-info">
              <div class="selected-mode" id="displayMode">Mode: -</div>
              <div class="selected-rarity" id="displayRarity">-</div>
            </div>
            <div class="selected-count" id="displayCount">0/6</div>
          </div>
          
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
            <button onclick="clearAllSelections()" style="flex: 1; padding: 0.5rem; background: #ff4444; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.75rem;">
              Clear All
            </button>
          </div>

          <div id="selectedOutput">
            <div class="empty-state">
              <div class="empty-icon">üì¶</div>
              <div>No modifiers selected</div>
            </div>
          </div>
          
          <button id="actionBtn" onclick="toggleSelectionMode()" style="display: block; margin-top: 1rem; width: 100%; padding: 0.75rem; background: #4a9eff; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
            Continue: Add More Modifiers ‚Üí
          </button>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-item">
        <span id="status">Initializing...</span>
      </div>
    </div>
  </div>

  <script src="http://localhost:5173/poe2.js"></script>
  <script>
    // DOM elements
    const statusEl = document.getElementById('status');
    const modeRaritySection = document.getElementById('modeRaritySection');
    const raritySection = document.getElementById('raritySection');
    const modifiersPanel = document.getElementById('modifiersPanel');
    const selectedPanel = document.getElementById('selectedPanel');
    const itemGrid = document.getElementById('itemGrid');
    const subtypeSection = document.getElementById('subtypeSection');
    const subtypeLabel = document.getElementById('subtypeLabel');
    const subtypeGrid = document.getElementById('subtypeGrid');
    const modSourceEl = document.getElementById('modSource');
    const modTypeEl = document.getElementById('modType');
    const prefixList = document.getElementById('prefixList');
    const suffixList = document.getElementById('suffixList');
    const selectedOutput = document.getElementById('selectedOutput');
    const displayMode = document.getElementById('displayMode');
    const displayRarity = document.getElementById('displayRarity');
    const displayCount = document.getElementById('displayCount');
    const selectionSummary = document.getElementById('selectionSummary');
    const modeBadge = document.getElementById('modeBadge');
    const rarityBadge = document.getElementById('rarityBadge');
    const rarityLabelSummary = document.getElementById('rarityLabelSummary');
    const modeSelectionBoxes = document.getElementById('modeSelectionBoxes');
    
    // State
    let api = null;
    let currentItemId = null;
    let currentMode = null;
    let currentRarity = null;
    let selectedModifiers = { prefixes: [], suffixes: [] };
    let existingModifiers = { prefixes: [], suffixes: [] }; // Track the initial existing mods before expansion
    let isExpandedMode = false; // Track if we're in expanded selection mode (beyond existing modifiers)
    
    // Item categories
    const ITEM_CATEGORIES = {
      'shields': {
        label: 'Shields',
        subtypes: [
          { id: 6, name: 'STR + INT' },
          { id: 7, name: 'STR' },
          { id: 8, name: 'STR + DEX' }
        ]
      },
      'helmets': {
        label: 'Helmets',
        subtypes: [
          { id: 10, name: 'STR + INT' },
          { id: 11, name: 'INT' },
          { id: 12, name: 'DEX + INT' },
          { id: 13, name: 'STR' },
          { id: 14, name: 'DEX' },
          { id: 15, name: 'STR + DEX' }
        ]
      },
      'boots': {
        label: 'Boots',
        subtypes: [
          { id: 17, name: 'STR + INT' },
          { id: 18, name: 'INT' },
          { id: 19, name: 'DEX + INT' },
          { id: 20, name: 'STR' },
          { id: 21, name: 'DEX' },
          { id: 22, name: 'STR + DEX' }
        ]
      },
      'gloves': {
        label: 'Gloves',
        subtypes: [
          { id: 25, name: 'STR + INT' },
          { id: 26, name: 'INT' },
          { id: 27, name: 'DEX + INT' },
          { id: 28, name: 'STR' },
          { id: 29, name: 'DEX' },
          { id: 30, name: 'STR + DEX' }
        ]
      },
      'body_armours': {
        label: 'Body Armours',
        subtypes: [
          { id: 31, name: 'STR' },
          { id: 32, name: 'STR + INT' },
          { id: 33, name: 'STR + DEX' },
          { id: 34, name: 'INT' },
          { id: 35, name: 'DEX' },
          { id: 36, name: 'DEX + INT' }
        ]
      }
    };
    
    const SIMPLE_ITEMS = [
      { id: 0, name: 'Bows' },
      { id: 1, name: 'Crossbows' },
      { id: 2, name: 'Quivers' },
      { id: 3, name: 'One Hand Maces' },
      { id: 4, name: 'Amulets' },
      { id: 5, name: 'Spears' },
      { id: 9, name: 'Two Hand Maces' },
      { id: 16, name: 'Sceptres' },
      { id: 23, name: 'Bucklers' },
      { id: 24, name: 'Rings' },
      { id: 37, name: 'Wands' },
      { id: 38, name: 'Quarterstaves' },
      { id: 39, name: 'Foci' },
      { id: 40, name: 'Staves' }
    ];
    
    // Initialize WASM
    statusEl.innerHTML = '<span class="warning">‚è≥ Loading WASM...</span>';
    
    if (typeof Module === 'undefined') {
      statusEl.innerHTML = '<span class="error">‚ùå poe2.js failed to load. Is server running on port 5173?</span>';
    } else {
      Module.onRuntimeInitialized = () => {
        try {
          api = {
            itemCount: Module.cwrap('get_items_count', 'number', []),
            modName: Module.cwrap('get_modifier_name', 'string', ['number', 'number']),
            modDescription: Module.cwrap('get_modifier_group', 'string', ['number', 'number']),
            modTierCount: Module.cwrap('get_modifier_tier_count', 'number', ['number', 'number']),
            modTierName: Module.cwrap('get_modifier_tier_name', 'string', ['number', 'number', 'number']),
            modTierLevelReq: Module.cwrap('get_modifier_tier_level_req', 'number', ['number', 'number', 'number']),
            modTierWeight: Module.cwrap('get_modifier_tier_weight', 'number', ['number', 'number', 'number']),
            modTierValueCount: Module.cwrap('get_modifier_tier_value_count', 'number', ['number', 'number', 'number']),
            modTierValueMin: Module.cwrap('get_modifier_tier_value_min', 'number', ['number', 'number', 'number', 'number']),
            modTierValueMax: Module.cwrap('get_modifier_tier_value_max', 'number', ['number', 'number', 'number', 'number']),
            itemPrefixCount: Module.cwrap('get_item_prefix_count', 'number', ['number', 'number']),
            itemSuffixCount: Module.cwrap('get_item_suffix_count', 'number', ['number', 'number']),
            itemPrefixSource: Module.cwrap('get_item_prefix_source', 'number', ['number', 'number', 'number']),
            itemPrefixIndex: Module.cwrap('get_item_prefix_index', 'number', ['number', 'number', 'number']),
            itemSuffixSource: Module.cwrap('get_item_suffix_source', 'number', ['number', 'number', 'number']),
            itemSuffixIndex: Module.cwrap('get_item_suffix_index', 'number', ['number', 'number', 'number'])
          };
          
          const c = api.itemCount();
          statusEl.innerHTML = `<span class="status-success">‚úÖ Ready</span> <span>${c} items ‚Ä¢ 1337 modifiers ‚Ä¢ 5471 tiers</span>`;
          
          // Populate item grid
          SIMPLE_ITEMS.forEach(item => {
            const box = document.createElement('div');
            box.className = 'item-box';
            box.textContent = item.name;
            box.onclick = () => selectItem('simple', item.id, box);
            itemGrid.appendChild(box);
          });
          
          Object.keys(ITEM_CATEGORIES).forEach(key => {
            const cat = ITEM_CATEGORIES[key];
            const box = document.createElement('div');
            box.className = 'item-box';
            box.textContent = cat.label;
            box.onclick = () => selectItem('category', key, box);
            itemGrid.appendChild(box);
          });
        } catch(e) {
          statusEl.innerHTML = `<span class="error">‚ùå Error: ${e.message}</span>`;
        }
      };
    }
    
    function selectItem(type, value, element) {
      document.querySelectorAll('#itemGrid .item-box').forEach(box => box.classList.remove('selected'));
      element.classList.add('selected');
      
      if (type === 'category') {
        const category = ITEM_CATEGORIES[value];
        subtypeLabel.textContent = category.label;
        subtypeGrid.innerHTML = '';
        
        category.subtypes.forEach(subtype => {
          const box = document.createElement('div');
          box.className = 'item-box';
          box.textContent = subtype.name;
          box.onclick = () => selectSubtype(subtype.id, box);
          subtypeGrid.appendChild(box);
        });
        
        subtypeSection.style.display = 'block';
        modeRaritySection.style.display = 'none';
      } else {
        subtypeSection.style.display = 'none';
        currentItemId = value;
        modeRaritySection.style.display = 'block';
        
        // Reload modifiers if we're already in modifier selection view
        if (modifiersPanel.style.display === 'flex') {
          loadModifiers();
        }
      }
    }
    
    function selectSubtype(itemId, element) {
      document.querySelectorAll('#subtypeGrid .item-box').forEach(box => box.classList.remove('selected'));
      element.classList.add('selected');
      currentItemId = itemId;
      modeRaritySection.style.display = 'block';
      
      // Reload modifiers if we're already in modifier selection view
      if (modifiersPanel.style.display === 'flex') {
        loadModifiers();
      }
    }
    
    function selectMode(mode) {
      currentMode = mode;
      
      // Hide mode selection boxes and show summary
      modeSelectionBoxes.style.display = 'none';
      selectionSummary.style.display = 'block';
      modeBadge.textContent = mode === 'scratch' ? 'From Scratch' : 'Improve';
      
      // Set default rarity based on mode
      if (mode === 'improve') {
        currentRarity = 'magic'; // Default to magic for improve mode
      } else {
        currentRarity = 'normal'; // Default to normal for scratch mode
      }
      
      raritySection.style.display = 'none';
      rarityLabelSummary.style.display = 'inline';
      document.getElementById('rarityDropdownInline').style.display = 'inline';
      document.getElementById('rarityDropdownInline').value = currentRarity;
      loadModifiers();
      modifiersPanel.style.display = 'flex';
      selectedPanel.style.display = 'flex';
      updateDisplayHeader();
    }
    
    function selectRarity() {
      const dropdown = document.getElementById('rarityDropdown');
      const rarity = dropdown.value;
      
      if (!rarity) return;
      
      currentRarity = rarity;
      
      // Hide rarity selection and update summary
      raritySection.style.display = 'none';
      rarityLabelSummary.style.display = 'inline';
      document.getElementById('rarityDropdownInline').style.display = 'inline';
      document.getElementById('rarityDropdownInline').value = rarity;
      
      loadModifiers();
      modifiersPanel.style.display = 'flex';
      selectedPanel.style.display = 'flex';
      updateDisplayHeader();
    }
    
    function onRarityChange() {
      const dropdown = document.getElementById('rarityDropdownInline');
      currentRarity = dropdown.value;
      updateDisplayHeader();
    }
    
    function changeSelection() {
      // Hide panels and reset to mode selection
      modifiersPanel.style.display = 'none';
      selectedPanel.style.display = 'none';
      selectionSummary.style.display = 'none';
      raritySection.style.display = 'none';
      modeSelectionBoxes.style.display = 'block';
      document.getElementById('rarityDropdownInline').style.display = 'none';
      
      // Reset selections
      selectedModifiers = { prefixes: [], suffixes: [] };
      currentMode = null;
      currentRarity = null;
    }
    

    
    function updateDisplayHeader() {
      if (currentMode && currentRarity) {
        displayMode.textContent = currentMode === 'scratch' ? 'Mode: Start from Scratch' : 'Mode: Improve Existing';
        
        if (currentRarity === 'normal') {
          displayRarity.textContent = 'Normal Item';
        } else if (currentRarity === 'magic') {
          displayRarity.textContent = 'Magic Item';
        } else {
          displayRarity.textContent = 'Rare Item';
        }
        displayRarity.className = `selected-rarity ${currentRarity}`;
        updateModifierCount();
      }
    }
    
    function updateModifierCount() {
      const total = selectedModifiers.prefixes.length + selectedModifiers.suffixes.length;
      let max = 6;
      
      if (currentRarity === 'magic' && !isExpandedMode) {
        max = 2; // Magic: max 1 prefix + 1 suffix existing (before expanding)
      } else {
        max = 6; // Expanded or Rare: 3 prefix + 3 suffix
      }
      
      displayCount.textContent = `${total}/${max}`;
      
      // Update prefix counter
      const prefixCounter = document.getElementById('prefixCounter');
      const prefixCount = selectedModifiers.prefixes.length;
      let prefixMax = 3;
      
      if (currentRarity === 'magic' && !isExpandedMode) {
        prefixMax = 1;
      }
      
      prefixCounter.textContent = `(${prefixCount}/${prefixMax})`;
      prefixCounter.style.color = prefixCount >= prefixMax ? '#ff4444' : '#888';
      
      // Update suffix counter
      const suffixCounter = document.getElementById('suffixCounter');
      const suffixCount = selectedModifiers.suffixes.length;
      let suffixMax = 3;
      
      if (currentRarity === 'magic' && !isExpandedMode) {
        suffixMax = 1;
      }
      
      suffixCounter.textContent = `(${suffixCount}/${suffixMax})`;
      suffixCounter.style.color = suffixCount >= suffixMax ? '#ff4444' : '#888';
    }
    
    function clearAllSelections() {
      // Reset all state
      selectedModifiers = { prefixes: [], suffixes: [] };
      existingModifiers = { prefixes: [], suffixes: [] };
      isExpandedMode = false;
      
      // Reset UI
      const actionBtn = document.getElementById('actionBtn');
      const stepDescription = document.getElementById('stepDescription');
      
      actionBtn.textContent = 'Continue: Add More Modifiers ‚Üí';
      actionBtn.onclick = toggleSelectionMode;
      stepDescription.textContent = 'Select the modifiers already on your item (0-2 max: 1 prefix and 1 suffix)';
      
      // Reload modifiers to reset everything
      loadModifiers();
      updateSelectedDisplay();
      updateModifierCount();
    }
    
    function toggleSelectionMode() {
      const actionBtn = document.getElementById('actionBtn');
      const stepDescription = document.getElementById('stepDescription');
      
      if (!isExpandedMode) {
        // Save existing modifiers before expanding
        existingModifiers.prefixes = [...selectedModifiers.prefixes];
        existingModifiers.suffixes = [...selectedModifiers.suffixes];
        
        // Expand to full selection mode
        isExpandedMode = true;
        actionBtn.textContent = 'Calculate Probabilities ‚Üí';
        actionBtn.onclick = finalizeSelection;
        
        const existingCount = existingModifiers.prefixes.length + existingModifiers.suffixes.length;
        const remaining = 6 - existingCount;
        stepDescription.textContent = `Existing modifiers locked. Now add up to ${remaining} more modifiers from all sources (up to ${3 - existingModifiers.prefixes.length} prefixes, ${3 - existingModifiers.suffixes.length} suffixes)`;
        
        // Disable checkboxes for existing modifiers so they can't be deselected
        existingModifiers.prefixes.forEach(mod => {
          const checkbox = document.getElementById(`prefix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.disabled = true;
            checkbox.parentElement.style.opacity = '0.7';
          }
        });
        
        existingModifiers.suffixes.forEach(mod => {
          const checkbox = document.getElementById(`suffix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.disabled = true;
            checkbox.parentElement.style.opacity = '0.7';
          }
        });
        
        // Reload modifiers to show all sources if magic
        if (currentRarity === 'magic') {
          reloadModifiers();
        }
        
        updateModifierCount();
      }
    }
    
    function finalizeSelection() {
      console.log('Final modifiers:', selectedModifiers);
      
      const totalPrefixes = selectedModifiers.prefixes.length;
      const totalSuffixes = selectedModifiers.suffixes.length;
      
      console.log(`Total item: ${totalPrefixes} prefixes, ${totalSuffixes} suffixes`);
      
      // TODO: Calculate probabilities
      alert(`Item will have ${totalPrefixes} prefixes and ${totalSuffixes} suffixes.\nProbability calculation will be implemented next!`);
    }
    
    function loadModifiers() {
      if (currentItemId === null || currentItemId === undefined) return;
      
      const sourceValue = modSourceEl.value;
      
      // Only reset selectedModifiers if NOT in expanded mode (preserve existing mods)
      if (!isExpandedMode) {
        selectedModifiers = { prefixes: [], suffixes: [] };
      }
      
      // Determine which sources to load
      let sourcesToLoad = [];
      if (sourceValue === 'all') {
        sourcesToLoad = [0, 1, 2]; // Normal, Desecrated, Essence
      } else {
        sourcesToLoad = [parseInt(sourceValue)];
      }
      
      console.log('Loading modifiers for item:', currentItemId, 'sources:', sourcesToLoad);
      
      // Load prefixes from all selected sources
      prefixList.innerHTML = '';
      const seenPrefixes = new Set();
      
      sourcesToLoad.forEach(source => {
        const prefixCount = api.itemPrefixCount(currentItemId, source);
        console.log('Source', source, 'prefix count:', prefixCount);
        
        for (let p = 0; p < prefixCount; p++) {
          const modSrc = api.itemPrefixSource(currentItemId, source, p);
          const modIdx = api.itemPrefixIndex(currentItemId, source, p);
          const modKey = `${modSrc}_${modIdx}`;
          
          // Skip if we've already added this modifier
          if (seenPrefixes.has(modKey)) continue;
          seenPrefixes.add(modKey);
          
          const modDesc = api.modDescription(modSrc, modIdx);
          const tierCount = api.modTierCount(modSrc, modIdx);
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'modifier-item';
        const checkboxId = `prefix_${modSrc}_${modIdx}`;
        const dropdownId = `prefix_tier_${modSrc}_${modIdx}`;
        
        // Determine source name and class
        let sourceName = '';
        let sourceClass = '';
        if (modSrc === 0) {
          sourceName = 'Normal';
          sourceClass = 'normal-source';
        } else if (modSrc === 1) {
          sourceName = 'Desecrated';
          sourceClass = 'desecrated-source';
        } else if (modSrc === 2) {
          sourceName = 'Essence';
          sourceClass = 'essence-source';
        } else if (modSrc === 3) {
          sourceName = 'Perfect Essence';
          sourceClass = 'essence-source';
        }
        
        // Build tier dropdown options with values (reversed - highest values = T1)
        let tierOptions = '';
        for (let t = tierCount - 1; t >= 0; t--) {
          const valueCount = api.modTierValueCount(modSrc, modIdx, t);
          let valueStr = '';
          for (let v = 0; v < valueCount; v++) {
            const min = api.modTierValueMin(modSrc, modIdx, t, v);
            const max = api.modTierValueMax(modSrc, modIdx, t, v);
            if (v > 0) valueStr += ', ';
            if (min === max) {
              valueStr += min;
            } else {
              valueStr += `${min}-${max}`;
            }
          }
          tierOptions += `<option value="${t}">T${tierCount - t}: ${valueStr}</option>`;
        }
        
        itemDiv.innerHTML = `
          <input type="checkbox" id="${checkboxId}">
          <label for="${checkboxId}">${modDesc}</label>
          <span class="source-badge ${sourceClass}">${sourceName}</span>
          <span class="tier-badge">${tierCount} tiers</span>
          <select class="tier-dropdown" id="${dropdownId}" style="display: none;">
            ${tierOptions}
          </select>
        `;
        
        // Make the entire div clickable except for dropdown
        itemDiv.onclick = function(e) {
          // Don't toggle if clicking on dropdown
          if (e.target.tagName === 'SELECT') return;
          
          e.preventDefault();
          e.stopPropagation();
          
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          toggleModifier('prefix', modSrc, modIdx, checkbox);
        };
        
        // Handle tier dropdown change
        const dropdown = itemDiv.querySelector('select');
        dropdown.onchange = function() {
          updateSelectedDisplay();
        };
        
          prefixList.appendChild(itemDiv);
        }
      });
      
      // Load suffixes from all selected sources
      suffixList.innerHTML = '';
      const seenSuffixes = new Set();
      
      sourcesToLoad.forEach(source => {
        const suffixCount = api.itemSuffixCount(currentItemId, source);
        console.log('Source', source, 'suffix count:', suffixCount);
        
        for (let s = 0; s < suffixCount; s++) {
          const modSrc = api.itemSuffixSource(currentItemId, source, s);
          const modIdx = api.itemSuffixIndex(currentItemId, source, s);
          const modKey = `${modSrc}_${modIdx}`;
          
          // Skip if we've already added this modifier
          if (seenSuffixes.has(modKey)) continue;
          seenSuffixes.add(modKey);
          
          const modDesc = api.modDescription(modSrc, modIdx);
          const tierCount = api.modTierCount(modSrc, modIdx);
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'modifier-item';
        const checkboxId = `suffix_${modSrc}_${modIdx}`;
        const dropdownId = `suffix_tier_${modSrc}_${modIdx}`;
        
        // Determine source name and class
        let sourceName = '';
        let sourceClass = '';
        if (modSrc === 0) {
          sourceName = 'Normal';
          sourceClass = 'normal-source';
        } else if (modSrc === 1) {
          sourceName = 'Desecrated';
          sourceClass = 'desecrated-source';
        } else if (modSrc === 2) {
          sourceName = 'Essence';
          sourceClass = 'essence-source';
        } else if (modSrc === 3) {
          sourceName = 'Perfect Essence';
          sourceClass = 'essence-source';
        }
        
        // Build tier dropdown options with values (reversed - highest values = T1)
        let tierOptions = '';
        for (let t = tierCount - 1; t >= 0; t--) {
          const valueCount = api.modTierValueCount(modSrc, modIdx, t);
          let valueStr = '';
          for (let v = 0; v < valueCount; v++) {
            const min = api.modTierValueMin(modSrc, modIdx, t, v);
            const max = api.modTierValueMax(modSrc, modIdx, t, v);
            if (v > 0) valueStr += ', ';
            if (min === max) {
              valueStr += min;
            } else {
              valueStr += `${min}-${max}`;
            }
          }
          tierOptions += `<option value="${t}">T${tierCount - t}: ${valueStr}</option>`;
        }
        
        itemDiv.innerHTML = `
          <input type="checkbox" id="${checkboxId}">
          <label for="${checkboxId}">${modDesc}</label>
          <span class="source-badge ${sourceClass}">${sourceName}</span>
          <span class="tier-badge">${tierCount} tiers</span>
          <select class="tier-dropdown" id="${dropdownId}" style="display: none;">
            ${tierOptions}
          </select>
        `;
        
        // Make the entire div clickable except for dropdown
        itemDiv.onclick = function(e) {
          // Don't toggle if clicking on dropdown
          if (e.target.tagName === 'SELECT') return;
          
          e.preventDefault();
          e.stopPropagation();
          
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          toggleModifier('suffix', modSrc, modIdx, checkbox);
        };
        
        // Handle tier dropdown change
        const dropdown = itemDiv.querySelector('select');
        dropdown.onchange = function() {
          updateSelectedDisplay();
        };
        
          suffixList.appendChild(itemDiv);
        }
      });
      
      filterModifiers();
      updateSelectedDisplay();
      
      // If in expanded mode, re-check and disable existing modifiers
      if (isExpandedMode) {
        existingModifiers.prefixes.forEach(mod => {
          const checkbox = document.getElementById(`prefix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
            const parent = checkbox.closest('.modifier-item');
            if (parent) {
              parent.classList.add('selected');
              parent.style.opacity = '0.7';
              const dropdown = parent.querySelector('.tier-dropdown');
              if (dropdown) dropdown.style.display = 'block';
            }
          }
        });
        
        existingModifiers.suffixes.forEach(mod => {
          const checkbox = document.getElementById(`suffix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
            const parent = checkbox.closest('.modifier-item');
            if (parent) {
              parent.classList.add('selected');
              parent.style.opacity = '0.7';
              const dropdown = parent.querySelector('.tier-dropdown');
              if (dropdown) dropdown.style.display = 'block';
            }
          }
        });
      }
    }
    
    function filterModifiers() {
      const filterType = modTypeEl.value;
      const prefixContainer = prefixList.parentElement;
      const suffixContainer = suffixList.parentElement;
      
      if (filterType === 'all') {
        prefixContainer.style.display = 'block';
        suffixContainer.style.display = 'block';
      } else if (filterType === 'prefix') {
        prefixContainer.style.display = 'block';
        suffixContainer.style.display = 'none';
      } else if (filterType === 'suffix') {
        prefixContainer.style.display = 'none';
        suffixContainer.style.display = 'block';
      }
    }
    
    function reloadModifiers() {
      loadModifiers();
    }
    
    function toggleModifier(type, source, index, checkbox) {
      const key = `${source}_${index}`;
      const array = type === 'prefix' ? selectedModifiers.prefixes : selectedModifiers.suffixes;
      const idx = array.findIndex(m => m.key === key);
      
      const parent = checkbox.closest('.modifier-item');
      const dropdown = parent.querySelector('.tier-dropdown');
      
      if (idx >= 0) {
        // In expanded mode, don't allow deselection of existing modifiers
        if (isExpandedMode) {
          const existingArray = type === 'prefix' ? existingModifiers.prefixes : existingModifiers.suffixes;
          const isExisting = existingArray.some(m => m.key === key);
          if (isExisting) {
            checkbox.checked = true; // Keep it checked
            return;
          }
        }
        
        // Deselect
        array.splice(idx, 1);
        parent.classList.remove('selected');
        dropdown.style.display = 'none';
      } else {
        // If selecting an essence (source === 2), deselect any other essence first
        if (source === 2) {
          const existingEssenceIdx = array.findIndex(m => m.source === 2);
          if (existingEssenceIdx >= 0) {
            const existingEssence = array[existingEssenceIdx];
            array.splice(existingEssenceIdx, 1);
            
            // Uncheck the previous essence checkbox and hide its dropdown
            const checkboxId = `${type}_${existingEssence.source}_${existingEssence.index}`;
            const existingCheckbox = document.getElementById(checkboxId);
            if (existingCheckbox) {
              existingCheckbox.checked = false;
              const existingParent = existingCheckbox.closest('.modifier-item');
              existingParent.classList.remove('selected');
              const existingDropdown = existingParent.querySelector('.tier-dropdown');
              existingDropdown.style.display = 'none';
            }
          }
        }
        
        // If selecting a desecrated (source === 1), deselect any other desecrated first
        if (source === 1) {
          const existingDesecratedIdx = array.findIndex(m => m.source === 1);
          if (existingDesecratedIdx >= 0) {
            const existingDesecrated = array[existingDesecratedIdx];
            array.splice(existingDesecratedIdx, 1);
            
            // Uncheck the previous desecrated checkbox and hide its dropdown
            const checkboxId = `${type}_${existingDesecrated.source}_${existingDesecrated.index}`;
            const existingCheckbox = document.getElementById(checkboxId);
            if (existingCheckbox) {
              existingCheckbox.checked = false;
              const existingParent = existingCheckbox.closest('.modifier-item');
              existingParent.classList.remove('selected');
              const existingDropdown = existingParent.querySelector('.tier-dropdown');
              existingDropdown.style.display = 'none';
            }
          }
        }
        // Check rarity-specific restrictions
        if (currentRarity === 'magic' && !isExpandedMode) {
          // Magic items in initial mode: only Normal modifiers, max 1 prefix and 1 suffix
          if (source !== 0) {
            checkbox.checked = false;
            return;
          }
          if (array.length >= 1) {
            checkbox.checked = false;
            return;
          }
        } else if (currentRarity === 'rare' || (currentRarity === 'magic' && isExpandedMode)) {
          // Rare items OR magic in expanded mode: allow up to 3 of each type
          if (array.length >= 3) {
            checkbox.checked = false;
            return;
          }
        }
        
        // Select
        const modDesc = api.modDescription(source, index);
        const tierCount = api.modTierCount(source, index);
        array.push({ key, source, index, description: modDesc, tierCount });
        parent.classList.add('selected');
        dropdown.style.display = 'block';
      }
      
      updateSelectedDisplay();
      updateModifierCount();
    }
    
    function updateSelectedDisplay() {
      if (selectedModifiers.prefixes.length === 0 && selectedModifiers.suffixes.length === 0) {
        selectedOutput.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <div>No modifiers selected</div>
          </div>
        `;
        return;
      }
      
      let output = '<div class="selected-list">';
      
      // Show existing modifiers section if in expanded mode
      if (isExpandedMode && (existingModifiers.prefixes.length > 0 || existingModifiers.suffixes.length > 0)) {
        output += '<div style="border-bottom: 2px solid #4a9eff; padding-bottom: 0.75rem; margin-bottom: 0.75rem;">';
        output += '<div style="font-weight: 600; color: #4a9eff; font-size: 0.75rem; margin-bottom: 0.5rem;">EXISTING MODIFIERS (LOCKED)</div>';
        
        if (existingModifiers.prefixes.length > 0) {
          output += '<div><div class="selected-group-title">Prefixes</div>';
          existingModifiers.prefixes.forEach(mod => {
            const dropdown = document.getElementById(`prefix_tier_${mod.source}_${mod.index}`);
            const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
            
            const tName = api.modTierName(mod.source, mod.index, selectedTier);
            const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
            const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
            const tierNum = mod.tierCount - selectedTier;
            
            const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
            let valueRange = '';
            for (let v = 0; v < valueCount; v++) {
              const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
              const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
              if (v > 0) valueRange += ', ';
              valueRange += `${min}-${max}`;
            }
            
            output += `
              <div class="selected-mod" style="opacity: 0.9;">
                <div class="selected-mod-desc">${mod.description}</div>
                <div class="selected-mod-tier">
                  <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
                </div>
              </div>
            `;
          });
          output += '</div>';
        }
        
        if (existingModifiers.suffixes.length > 0) {
          output += '<div><div class="selected-group-title">Suffixes</div>';
          existingModifiers.suffixes.forEach(mod => {
            const dropdown = document.getElementById(`suffix_tier_${mod.source}_${mod.index}`);
            const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
            
            const tName = api.modTierName(mod.source, mod.index, selectedTier);
            const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
            const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
            const tierNum = mod.tierCount - selectedTier;
            
            const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
            let valueRange = '';
            for (let v = 0; v < valueCount; v++) {
              const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
              const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
              if (v > 0) valueRange += ', ';
              valueRange += `${min}-${max}`;
            }
            
            output += `
              <div class="selected-mod" style="opacity: 0.9;">
                <div class="selected-mod-desc">${mod.description}</div>
                <div class="selected-mod-tier">
                  <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
                </div>
              </div>
            `;
          });
          output += '</div>';
        }
        
        output += '</div>';
      }
      
      // Show additional modifiers section if in expanded mode
      if (isExpandedMode) {
        const additionalPrefixes = selectedModifiers.prefixes.filter(m => 
          !existingModifiers.prefixes.some(em => em.key === m.key)
        );
        const additionalSuffixes = selectedModifiers.suffixes.filter(m => 
          !existingModifiers.suffixes.some(em => em.key === m.key)
        );
        
        if (additionalPrefixes.length > 0 || additionalSuffixes.length > 0) {
          output += '<div style="font-weight: 600; color: #888; font-size: 0.75rem; margin-bottom: 0.5rem;">ADDITIONAL MODIFIERS</div>';
          
          if (additionalPrefixes.length > 0) {
            output += '<div><div class="selected-group-title">Prefixes</div>';
            additionalPrefixes.forEach(mod => {
              const dropdown = document.getElementById(`prefix_tier_${mod.source}_${mod.index}`);
              const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
              
              const tName = api.modTierName(mod.source, mod.index, selectedTier);
              const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
              const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
              const tierNum = mod.tierCount - selectedTier;
              
              const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
              let valueRange = '';
              for (let v = 0; v < valueCount; v++) {
                const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
                const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
                if (v > 0) valueRange += ', ';
                valueRange += `${min}-${max}`;
              }
              
              output += `
                <div class="selected-mod">
                  <div class="selected-mod-desc">${mod.description}</div>
                  <div class="selected-mod-tier">
                    <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
                  </div>
                </div>
              `;
            });
            output += '</div>';
          }
          
          if (additionalSuffixes.length > 0) {
            output += '<div><div class="selected-group-title">Suffixes</div>';
            additionalSuffixes.forEach(mod => {
              const dropdown = document.getElementById(`suffix_tier_${mod.source}_${mod.index}`);
              const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
              
              const tName = api.modTierName(mod.source, mod.index, selectedTier);
              const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
              const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
              const tierNum = mod.tierCount - selectedTier;
              
              const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
              let valueRange = '';
              for (let v = 0; v < valueCount; v++) {
                const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
                const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
                if (v > 0) valueRange += ', ';
                valueRange += `${min}-${max}`;
              }
              
              output += `
                <div class="selected-mod">
                  <div class="selected-mod-desc">${mod.description}</div>
                  <div class="selected-mod-tier">
                    <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
                  </div>
                </div>
              `;
            });
            output += '</div>';
          }
        }
      } else {
        // Not in expanded mode, show all modifiers normally
        if (selectedModifiers.prefixes.length > 0) {
          output += '<div><div class="selected-group-title">Prefixes</div>';
          selectedModifiers.prefixes.forEach(mod => {
            const dropdown = document.getElementById(`prefix_tier_${mod.source}_${mod.index}`);
            const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
            
            const tName = api.modTierName(mod.source, mod.index, selectedTier);
            const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
            const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
            const tierNum = mod.tierCount - selectedTier;
            
            const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
            let valueRange = '';
            for (let v = 0; v < valueCount; v++) {
              const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
              const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
              if (v > 0) valueRange += ', ';
              valueRange += `${min}-${max}`;
            }
            
            output += `
              <div class="selected-mod">
                <div class="selected-mod-desc">${mod.description}</div>
                <div class="selected-mod-tier">
                  <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
                </div>
              </div>
            `;
          });
          output += '</div>';
        }
      
      if (selectedModifiers.suffixes.length > 0) {
        output += '<div><div class="selected-group-title">Suffixes</div>';
        selectedModifiers.suffixes.forEach(mod => {
          const dropdown = document.getElementById(`suffix_tier_${mod.source}_${mod.index}`);
          const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
          
          const tName = api.modTierName(mod.source, mod.index, selectedTier);
          const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
          const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
          const tierNum = mod.tierCount - selectedTier;
          
          // Get value range for selected tier
          const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
          let valueRange = '';
          const valuePairs = [];
          const seenPairs = new Set();
          
          for (let v = 0; v < valueCount; v++) {
            const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
            const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
            const pairKey = `${min}-${max}`;
            
            // Only add unique value pairs
            if (!seenPairs.has(pairKey)) {
              seenPairs.add(pairKey);
              valuePairs.push(pairKey);
            }
          }
          
          valueRange = valuePairs.join(', ');
          
          output += `
            <div class="selected-mod">
              <div class="selected-mod-desc">${mod.description}</div>
              <div class="selected-mod-tier">
                <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
              </div>
            </div>
          `;
        });
        output += '</div>';
      }
      }
      
      output += '</div>';
      selectedOutput.innerHTML = output;
    }
  </script>
</body>
</html>
