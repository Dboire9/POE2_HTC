<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>POE2 WASM Engine - Crafting Simulator</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --bg-primary: #0d0d0d;
      --bg-secondary: #1a1a1a;
      --bg-tertiary: #242424;
      --border: #333333;
      --border-light: #404040;
      --text-primary: #e8e8e8;
      --text-secondary: #b8b8b8;
      --text-muted: #808080;
      --accent: #ff8c42;
      --accent-hover: #ffa05c;
      --accent-dark: #e67a32;
      --success: #4ade80;
      --error: #f87171;
      --magic: #6495ed;
      --rare: #ffd700;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', sans-serif;
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      height: 100vh;
      overflow: hidden;
    }
    
    .app-container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    /* Header */
    header {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0.75rem 1.5rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .logo h1 {
      font-size: 1.25rem;
      font-weight: 700;
      color: var(--accent);
      letter-spacing: 0.5px;
    }
    
    .beta-badge {
      font-size: 0.65rem;
      color: var(--accent);
      background: rgba(255, 140, 66, 0.15);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
      font-weight: 600;
      border: 1px solid rgba(255, 140, 66, 0.3);
    }
    
    .header-links {
      display: flex;
      gap: 0.5rem;
    }
    
    .header-link {
      padding: 0.4rem 0.75rem;
      font-size: 0.75rem;
      border-radius: 6px;
      text-decoration: none;
      color: var(--text-secondary);
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    
    .header-link:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.1);
    }
    
    /* Main Content */
    .main-content {
      flex: 1;
      display: grid;
      grid-template-columns: 1fr 1fr 400px;
      gap: 1rem;
      padding: 1rem;
      overflow: hidden;
    }
    
    /* Panels */
    .panel {
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 0.75rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid var(--border);
    }
    
    .panel-title {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .panel-step {
      font-size: 0.7rem;
      color: var(--text-muted);
      background: var(--bg-tertiary);
      padding: 0.15rem 0.5rem;
      border-radius: 4px;
    }
    
    .panel-content {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }
    
    .panel-content::-webkit-scrollbar {
      width: 6px;
    }
    
    .panel-content::-webkit-scrollbar-track {
      background: var(--bg-tertiary);
      border-radius: 3px;
    }
    
    .panel-content::-webkit-scrollbar-thumb {
      background: var(--border-light);
      border-radius: 3px;
    }
    
    .panel-content::-webkit-scrollbar-thumb:hover {
      background: var(--accent);
    }
    
    /* Item Selection */
    .item-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      gap: 0.5rem;
    }
    
    .item-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem 0.5rem;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.7rem;
      font-weight: 500;
      color: var(--text-secondary);
    }
    
    .item-box:hover {
      border-color: var(--accent);
      color: var(--accent);
      transform: translateY(-1px);
    }
    
    .item-box.selected {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.15);
      color: var(--accent);
    }
    
    /* Mode & Rarity Selection */
    .selection-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 0.75rem;
    }
    
    .selection-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 1rem;
      cursor: pointer;
      transition: all 0.2s;
      text-align: center;
    }
    
    .selection-box:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    
    .selection-box.magic { border-color: var(--magic); }
    .selection-box.rare { border-color: var(--rare); }
    
    .selection-icon {
      font-size: 2rem;
      margin-bottom: 0.5rem;
    }
    
    .selection-title {
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: var(--text-primary);
    }
    
    .selection-desc {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    
    .selection-box.magic .selection-title { color: var(--magic); }
    .selection-box.rare .selection-title { color: var(--rare); }
    
    /* Selection Summary */
    .selection-summary {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      margin-bottom: 0.75rem;
      flex-wrap: wrap;
    }
    
    .summary-label {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    
    .summary-badge {
      font-size: 0.7rem;
      font-weight: 600;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: rgba(255, 140, 66, 0.15);
      color: var(--accent);
      border: 1px solid rgba(255, 140, 66, 0.3);
    }
    
    .summary-badge.magic {
      background: rgba(100, 149, 237, 0.15);
      color: var(--magic);
      border-color: rgba(100, 149, 237, 0.3);
    }
    
    .summary-badge.rare {
      background: rgba(255, 215, 0, 0.15);
      color: var(--rare);
      border-color: rgba(255, 215, 0, 0.3);
    }
    
    .summary-badge.normal {
      background: rgba(200, 200, 200, 0.15);
      color: var(--text-secondary);
      border-color: rgba(200, 200, 200, 0.3);
    }
    
    .summary-badge.clickable {
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .summary-badge.clickable:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .summary-badge.magic.clickable:hover {
      background: rgba(100, 149, 237, 0.25);
      border-color: var(--magic);
    }
    
    .summary-badge.rare.clickable:hover {
      background: rgba(255, 215, 0, 0.25);
      border-color: var(--rare);
    }
    
    .summary-badge.normal.clickable:hover {
      background: rgba(200, 200, 200, 0.25);
      border-color: var(--text-secondary);
    }
    
    .change-btn {
      font-size: 0.7rem;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.2s;
      margin-left: auto;
    }
    
    .change-btn:hover {
      color: var(--accent);
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.1);
    }
    
    /* Currency Selection */
    .currency-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .currency-item {
      background: var(--bg-tertiary);
      border: 2px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
      position: relative;
    }
    
    .currency-item:hover {
      border-color: var(--accent);
      transform: translateY(-1px);
    }
    
    .currency-item.enabled {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.15);
    }
    
    .currency-item.disabled {
      opacity: 0.5;
      border-color: var(--error);
      background: rgba(248, 113, 113, 0.1);
    }
    
    .currency-checkbox {
      position: absolute;
      top: 0.5rem;
      right: 0.5rem;
      width: 16px;
      height: 16px;
      border: 2px solid var(--border);
      border-radius: 3px;
      background: var(--bg-tertiary);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      color: var(--accent);
    }
    
    .currency-item.enabled .currency-checkbox {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .currency-name {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--text-primary);
      text-align: center;
    }
    
    .currency-controls {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .currency-btn {
      flex: 1;
      padding: 0.5rem;
      font-size: 0.75rem;
      border-radius: 6px;
      border: 1px solid var(--border);
      background: var(--bg-tertiary);
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .currency-btn:hover {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.1);
      color: var(--accent);
    }
    
    /* Omen Selection */
    .omen-section {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      border: 1px solid var(--border);
    }
    
    .omen-title {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--text-secondary);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .omen-list {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }
    
    .omen-currency-group {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
    }
    
    .omen-dropdown-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.5rem;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .omen-dropdown-header:hover {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.05);
    }
    
    .omen-dropdown-arrow {
      font-size: 0.6rem;
      transition: transform 0.2s;
    }
    
    .omen-dropdown-arrow.open {
      transform: rotate(90deg);
    }
    
    .omen-dropdown-label {
      flex: 1;
      color: var(--text-secondary);
      font-weight: 600;
    }
    
    .omen-dropdown-content {
      display: none;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.25rem;
      padding: 0.25rem 0 0.25rem 1rem;
    }
    
    .omen-dropdown-content.open {
      display: flex;
    }
    
    .omen-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.5rem;
      background: var(--bg-primary);
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.7rem;
    }
    
    .omen-item:hover {
      background: rgba(255, 140, 66, 0.1);
    }
    
    .omen-checkbox {
      width: 12px;
      height: 12px;
      border: 2px solid var(--border);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      flex-shrink: 0;
    }
    
    .omen-item.enabled .omen-checkbox {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .omen-name {
      flex: 1;
      color: var(--text-primary);
    }
    
    /* Currency Tiers */
    .currency-tiers {
      margin-top: 0.5rem;
      padding-left: 1.5rem;
    }
    
    .tier-dropdown-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.4rem 0.5rem;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.7rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .tier-dropdown-header:hover {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.05);
    }
    
    .tier-dropdown-arrow {
      font-size: 0.6rem;
      transition: transform 0.2s;
    }
    
    .tier-dropdown-arrow.open {
      transform: rotate(90deg);
    }
    
    .tier-dropdown-label {
      flex: 1;
      color: var(--text-secondary);
    }
    
    .tier-dropdown-content {
      display: none;
      flex-direction: column;
      gap: 0.25rem;
      margin-top: 0.25rem;
      padding: 0.25rem 0;
    }
    
    .tier-dropdown-content.open {
      display: flex;
    }
    
    .tier-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.35rem 0.5rem;
      background: var(--bg-primary);
      border-radius: 3px;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 0.7rem;
    }
    
    .tier-item:hover {
      background: rgba(255, 140, 66, 0.1);
    }
    
    .tier-checkbox {
      width: 12px;
      height: 12px;
      border: 2px solid var(--border);
      border-radius: 3px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 8px;
      flex-shrink: 0;
    }
    
    .tier-item.enabled .tier-checkbox {
      background: var(--accent);
      border-color: var(--accent);
      color: white;
    }
    
    .tier-name {
      flex: 1;
      color: var(--text-primary);
      text-transform: capitalize;
    }
    
    /* Modifier Selection */
    .mod-filters {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 0.75rem;
    }
    
    .mod-filter-group {
      flex: 1;
    }
    
    .mod-filter-label {
      font-size: 0.65rem;
      color: var(--text-muted);
      margin-bottom: 0.25rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .mod-source {
      margin-bottom: 0.75rem;
    }
    
    .mod-source select,
    .mod-filter-group select {
      width: 100%;
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      color: var(--text-primary);
      padding: 0.5rem;
      border-radius: 6px;
      font-size: 0.75rem;
      cursor: pointer;
    }
    
    .mod-source select:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    .mod-lists {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .mod-group-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .mod-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 0.5rem;
    }
    
    .modifier-item {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.5rem;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .modifier-item:hover {
      border-color: var(--accent);
    }
    
    .modifier-item.selected {
      border-color: var(--accent);
      background: rgba(255, 140, 66, 0.1);
    }
    
    .modifier-item input[type="checkbox"] {
      display: none;
    }
    
    .modifier-item label {
      font-size: 0.7rem;
      color: var(--text-secondary);
      cursor: pointer;
      display: block;
      margin-bottom: 0.25rem;
      word-wrap: break-word;
      line-height: 1.3;
    }
    
    .modifier-item.selected label {
      color: var(--accent);
    }
    
    .modifier-badges {
      display: flex;
      flex-wrap: wrap;
      gap: 0.25rem;
      align-items: center;
    }
    
    .tier-badge {
      display: inline-block;
      font-size: 0.6rem;
      color: var(--text-muted);
      background: var(--bg-primary);
      padding: 0.1rem 0.3rem;
      border-radius: 3px;
      white-space: nowrap;
    }
    
    .family-badge {
      display: inline-block;
      font-size: 0.6rem;
      font-weight: 600;
      color: #60a5fa;
      background: rgba(96, 165, 250, 0.15);
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      border: 1px solid rgba(96, 165, 250, 0.3);
      cursor: help;
      max-width: 120px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    
    .source-badge {
      display: inline-block;
      font-size: 0.6rem;
      font-weight: 600;
      padding: 0.15rem 0.4rem;
      border-radius: 3px;
      margin-left: 0.25rem;
    }
    
    .source-badge.normal-source {
      background: rgba(184, 184, 184, 0.2);
      color: var(--text-secondary);
    }
    
    .source-badge.desecrated-source {
      background: rgba(139, 69, 255, 0.2);
      color: #b89fff;
    }
    
    .source-badge.essence-source {
      background: rgba(74, 222, 128, 0.2);
      color: var(--success);
    }
    
    .tier-dropdown {
      width: 100%;
      background: var(--bg-primary);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      padding: 0.25rem;
      border-radius: 4px;
      font-size: 0.65rem;
      margin-top: 0.375rem;
    }
    
    .tier-dropdown:focus {
      outline: none;
      border-color: var(--accent);
    }
    
    /* Selected Modifiers Panel */
    .selected-header {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: var(--bg-tertiary);
      border-radius: 6px;
      margin-bottom: 0.75rem;
    }
    
    .selected-info {
      flex: 1;
    }
    
    .selected-mode {
      font-size: 0.7rem;
      color: var(--text-muted);
    }
    
    .selected-rarity {
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--text-primary);
    }
    
    .selected-rarity.magic { color: var(--magic); }
    .selected-rarity.rare { color: var(--rare); }
    
    .selected-count {
      font-size: 0.7rem;
      color: var(--accent);
      background: rgba(255, 140, 66, 0.15);
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
    }
    
    .selected-list {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }
    
    .selected-group-title {
      font-size: 0.75rem;
      font-weight: 600;
      color: var(--accent);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    
    .selected-mod {
      background: var(--bg-tertiary);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 0.75rem;
    }
    
    .selected-mod-desc {
      font-size: 0.75rem;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-weight: 500;
    }
    
    .selected-mod-tier {
      font-size: 0.7rem;
      color: var(--text-secondary);
    }
    
    .tier-name {
      color: var(--accent);
      font-weight: 600;
    }
    
    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-muted);
      font-size: 0.875rem;
    }
    
    .empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.3;
    }
    
    /* Status Bar */
    .status-bar {
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      padding: 0.5rem 1.5rem;
      font-size: 0.7rem;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      gap: 1rem;
      flex-shrink: 0;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .status-success { color: var(--success); }
    .status-warning { color: var(--accent); }
    
    @media (max-width: 1600px) {
      .main-content {
        grid-template-columns: 1fr 1fr 350px;
      }
      
      .header-links {
        display: none;
      }
    }
    
    @media (max-width: 900px) {
      .main-content {
        grid-template-columns: 1fr;
        grid-template-rows: auto auto 1fr;
      }
    }
  </style>
</head>
<body>
  <div class="app-container">
    <header>
      <div class="logo">
        <h1>POE2HTC</h1>
        <span class="beta-badge">BETA</span>
      </div>
      <div class="header-links">
        <a href="https://discord.gg/RvxCWyFF3D" target="_blank" class="header-link">üí¨ Discord</a>
        <a href="https://github.com/Dboire9/POE2_HTC/issues/new" target="_blank" class="header-link">üêõ Bug</a>
        <a href="https://buymeacoffee.com/dboire" target="_blank" class="header-link">‚òï Support</a>
        <a href="https://github.com/Dboire9/POE2_HTC" target="_blank" class="header-link">‚≠ê GitHub</a>
      </div>
    </header>

    <div class="main-content">
      <!-- Left Panel: Item & Mode & Rarity -->
      <div class="panel">
        <div class="panel-header">
          <span class="panel-title">Setup</span>
          <span class="panel-step">Steps 1-3</span>
        </div>
        <div class="panel-content">
          <!-- Item Selection -->
          <div style="margin-bottom: 1.5rem;">
            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Base Item</div>
            <div id="itemGrid" class="item-grid"></div>
            <div id="subtypeSection" style="display: none; margin-top: 0.75rem;">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;" id="subtypeLabel">Subtype</div>
              <div id="subtypeGrid" class="item-grid"></div>
            </div>
          </div>

          <!-- Mode & Rarity Selection -->
          <div id="modeRaritySection" style="display: none;">
            <!-- Selection Summary -->
            <div id="selectionSummary" style="display: none;">
              <div class="selection-summary">
                <span class="summary-label">Mode:</span>
                <span class="summary-badge" id="modeBadge"></span>
                <span class="summary-label" id="rarityLabelSummary" style="display: none;">Rarity:</span>
                <select id="rarityDropdownInline" onchange="onRarityChange()" style="display: none; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; cursor: pointer; font-weight: 600;">
                  <option value="normal">Normal</option>
                  <option value="magic">Magic</option>
                  <option value="rare">Rare</option>
                </select>
                <span class="summary-label" id="ilvlLabelSummary" style="display: none;">iLvl:</span>
                <input type="number" id="ilvlInputInline" min="1" max="100" value="82" onchange="onItemLevelChangeInline()" style="display: none; width: 60px; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.25rem 0.5rem; border-radius: 4px; font-size: 0.7rem; font-weight: 600;">
                <button class="change-btn" onclick="changeSelection()">Change</button>
              </div>
            </div>
            
            <!-- Mode Selection Boxes -->
            <div id="modeSelectionBoxes">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Crafting Mode</div>
              <div class="selection-grid" style="margin-bottom: 1.5rem;">
                <div class="selection-box" onclick="selectMode('scratch')">
                  <div class="selection-title">From Scratch</div>
                  <div class="selection-desc">Start with blank item</div>
                </div>
                <div class="selection-box" onclick="selectMode('improve')">
                  <div class="selection-title">Improve</div>
                  <div class="selection-desc">Add/improve mods</div>
                </div>
              </div>
            </div>

            <!-- Rarity Selection -->
            <div id="raritySection" style="display: none;">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Item Rarity</div>
              <select id="rarityDropdown" onchange="selectRarity()" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.5rem; border-radius: 6px; font-size: 0.75rem; cursor: pointer;">
                <option value="">Select rarity...</option>
                <option value="normal">Normal</option>
                <option value="magic">Magic</option>
                <option value="rare">Rare</option>
              </select>
            </div>
            
            <!-- Item Level Selection -->
            <div id="ilvlSection" style="display: none; margin-top: 1rem;">
              <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Item Level</div>
              <input type="number" id="ilvlInput" min="1" max="100" value="82" onchange="onItemLevelChange()" style="width: 100%; background: var(--bg-tertiary); border: 1px solid var(--border); color: var(--text-primary); padding: 0.5rem; border-radius: 6px; font-size: 0.75rem;">
              <div style="font-size: 0.65rem; color: var(--text-muted); margin-top: 0.25rem;">Only tiers with level req ‚â§ item level will be shown</div>
            </div>
          </div>

          <!-- Currency Selection -->
          <div id="currencySelectionSection" style="display: none; margin-top: 1.5rem;">
            <div style="font-size: 0.75rem; font-weight: 600; color: var(--text-primary); margin-bottom: 0.5rem;">Allowed Currencies</div>
            <div class="currency-controls">
              <button class="currency-btn" onclick="enableAllCurrencies()">‚úì Enable All</button>
              <button class="currency-btn" onclick="disableAllCurrencies()">‚úó Disable All</button>
            </div>
            <div id="currencyGrid" class="currency-grid"></div>
            
            <!-- Omens Section -->
            <div id="omenSection" class="omen-section">
              <div class="omen-title">Disabled Omens</div>
              <div id="omenList" class="omen-list"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Middle Panel: Modifiers -->
      <div class="panel" id="modifiersPanel" style="display: none;">
        <div class="panel-header">
          <span class="panel-title">Select Modifiers</span>
          <span class="panel-step">Step 4</span>
        </div>
        <div class="panel-content">
          <div id="stepDescription" style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.75rem;">
            Select the modifiers already on your item (0-2 max: 1 prefix and 1 suffix)
          </div>
          <div class="mod-filters">
            <div class="mod-filter-group">
              <div class="mod-filter-label">Source</div>
              <select id="modSource" onchange="reloadModifiers()">
                <option value="0">Normal</option>
                <option value="1">Desecrated</option>
                <option value="2">Essence</option>
                <option value="all" selected>All Sources</option>
              </select>
            </div>
            <div class="mod-filter-group">
              <div class="mod-filter-label">Type</div>
              <select id="modType" onchange="filterModifiers()">
                <option value="all">All Types</option>
                <option value="prefix">Prefixes Only</option>
                <option value="suffix">Suffixes Only</option>
              </select>
            </div>
          </div>

          <div class="mod-lists">
            <div>
              <div class="mod-group-title">Prefixes <span id="prefixCounter" style="color: #888;">(0/3)</span></div>
              <div id="prefixList" class="mod-grid"></div>
            </div>
            <div>
              <div class="mod-group-title">Suffixes <span id="suffixCounter" style="color: #888;">(0/3)</span></div>
              <div id="suffixList" class="mod-grid"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Right Panel: Selected Output -->
      <div class="panel" id="selectedPanel" style="display: none;">
        <div class="panel-header">
          <span class="panel-title">Selected</span>
        </div>
        <div class="panel-content">
          <div class="selected-header">
            <div class="selected-info">
              <div class="selected-mode" id="displayMode">Mode: -</div>
              <div class="selected-rarity" id="displayRarity">-</div>
            </div>
            <div class="selected-count" id="displayCount">0/6</div>
          </div>
          
          <div style="display: flex; gap: 0.5rem; margin-bottom: 0.75rem;">
            <button onclick="clearAllSelections()" style="flex: 1; padding: 0.5rem; background: #ff4444; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.75rem;">
              Clear All
            </button>
            <button onclick="showImportDialog()" style="flex: 1; padding: 0.5rem; background: #4caf50; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.75rem;">
              Import Item
            </button>
            <button onclick="exportItem()" style="flex: 1; padding: 0.5rem; background: #ff9800; color: white; border: none; border-radius: 4px; font-weight: 600; cursor: pointer; font-size: 0.75rem;">
              Export Item
            </button>
          </div>

          <div id="selectedOutput">
            <div class="empty-state">
              <div class="empty-icon">üì¶</div>
              <div>No modifiers selected</div>
            </div>
          </div>
          
          <button id="actionBtn" onclick="toggleSelectionMode()" style="display: block; margin-top: 1rem; width: 100%; padding: 0.75rem; background: #4a9eff; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer; font-size: 0.875rem;">
            Continue: Add More Modifiers ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Import Modal -->
    <div id="importModal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); z-index: 9999; justify-content: center; align-items: center;">
      <div style="background: var(--bg-secondary); border-radius: 8px; padding: 1.5rem; max-width: 600px; width: 90%; max-height: 80vh; display: flex; flex-direction: column;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
          <h3 style="margin: 0; color: var(--text-primary);">Import Item from Path of Exile 2</h3>
          <button onclick="closeImportDialog()" style="background: none; border: none; color: var(--text-secondary); font-size: 1.5rem; cursor: pointer; padding: 0; width: 30px; height: 30px;">√ó</button>
        </div>
        <div style="font-size: 0.875rem; color: var(--text-secondary); margin-bottom: 1rem;">
          Copy your item in-game (Ctrl+Alt+C) and paste the text below:
        </div>
        <textarea id="importTextarea" placeholder="Paste item text here..." style="flex: 1; min-height: 300px; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 4px; padding: 0.75rem; color: var(--text-primary); font-family: monospace; font-size: 0.875rem; resize: vertical;"></textarea>
        <div style="display: flex; gap: 0.75rem; margin-top: 1rem;">
          <button onclick="closeImportDialog()" style="flex: 1; padding: 0.75rem; background: var(--bg-tertiary); color: var(--text-primary); border: 1px solid var(--border-color); border-radius: 6px; font-weight: 600; cursor: pointer;">
            Cancel
          </button>
          <button onclick="processImport()" style="flex: 1; padding: 0.75rem; background: #4caf50; color: white; border: none; border-radius: 6px; font-weight: 600; cursor: pointer;">
            Import Item
          </button>
        </div>
      </div>
    </div>

    <div class="status-bar">
      <div class="status-item">
        <span id="status">Initializing...</span>
      </div>
    </div>
  </div>

  <script src="http://localhost:5173/poe2.js?v=20251228-1905"></script>
  <script>
    // DOM elements
    const statusEl = document.getElementById('status');
    const modeRaritySection = document.getElementById('modeRaritySection');
    const raritySection = document.getElementById('raritySection');
    const modifiersPanel = document.getElementById('modifiersPanel');
    const selectedPanel = document.getElementById('selectedPanel');
    const itemGrid = document.getElementById('itemGrid');
    const subtypeSection = document.getElementById('subtypeSection');
    const subtypeLabel = document.getElementById('subtypeLabel');
    const subtypeGrid = document.getElementById('subtypeGrid');
    const modSourceEl = document.getElementById('modSource');
    const modTypeEl = document.getElementById('modType');
    const prefixList = document.getElementById('prefixList');
    const suffixList = document.getElementById('suffixList');
    const selectedOutput = document.getElementById('selectedOutput');
    const displayMode = document.getElementById('displayMode');
    const displayRarity = document.getElementById('displayRarity');
    const displayCount = document.getElementById('displayCount');
    const selectionSummary = document.getElementById('selectionSummary');
    const modeBadge = document.getElementById('modeBadge');
    const rarityBadge = document.getElementById('rarityBadge');
    const rarityLabelSummary = document.getElementById('rarityLabelSummary');
    const modeSelectionBoxes = document.getElementById('modeSelectionBoxes');
    
    // State
    let api = null;
    let currentItemId = null;
    let currentMode = null;
    let currentRarity = null;
    let currentItemLevel = 82;
    let selectedModifiers = { prefixes: [], suffixes: [] };
    let existingModifiers = { prefixes: [], suffixes: [] }; // Track the initial existing mods before expansion
    let isExpandedMode = false; // Track if we're in expanded selection mode (beyond existing modifiers)
    
    // Currency state
    let enabledCurrencies = new Set([
      'transmutation',
      'augmentation',
      'regal',
      'exalted',
      'annulment',
      'essence',
      'perfect_essence',
      'desecrated'
    ]);
    
    let disabledOmens = new Set();
    let disabledCurrencyTiers = new Set();
    
    const CURRENCIES = [
      { id: 'transmutation', name: 'Transmutation Orb', tiers: ['base', 'greater', 'perfect'] },
      { id: 'augmentation', name: 'Augmentation Orb', tiers: ['base', 'greater', 'perfect'] },
      { id: 'regal', name: 'Regal Orb', tiers: ['base', 'greater', 'perfect'] },
      { id: 'exalted', name: 'Exalted Orb', tiers: ['base', 'greater', 'perfect'] },
      { id: 'annulment', name: 'Annulment Orb', tiers: [] },
      { id: 'essence', name: 'Essence', tiers: ['lesser', 'normal', 'greater'] },
      { id: 'perfect_essence', name: 'Perfect Essence', tiers: [] },
      { id: 'desecrated', name: 'Desecrated', tiers: ['gnawed', 'preserved', 'ancient'] }
    ];
    
    const OMENS = [
      { id: 'exalted_sinistral', name: 'Omen of Sinistral Exaltation', currency: 'exalted' },
      { id: 'exalted_dextral', name: 'Omen of Dextral Exaltation', currency: 'exalted' },
      { id: 'exalted_greater', name: 'Omen of Greater Exaltation', currency: 'exalted' },
      { id: 'annulment_sinistral', name: 'Omen of Sinistral Annulment', currency: 'annulment' },
      { id: 'annulment_dextral', name: 'Omen of Dextral Annulment', currency: 'annulment' },
      { id: 'annulment_light', name: 'Omen of Light', currency: 'annulment' },
      { id: 'essence_sinistral', name: 'Omen of Sinistral Crystallisation', currency: 'essence' },
      { id: 'essence_dextral', name: 'Omen of Dextral Crystallisation', currency: 'essence' },
      { id: 'perfect_essence_sinistral', name: 'Omen of Sinistral Crystallisation', currency: 'perfect_essence' },
      { id: 'perfect_essence_dextral', name: 'Omen of Dextral Crystallisation', currency: 'perfect_essence' },
      { id: 'regal_sinistral', name: 'Omen of Sinistral Coronation', currency: 'regal' },
      { id: 'regal_dextral', name: 'Omen of Dextral Coronation', currency: 'regal' },
      { id: 'desecrated_dextral', name: 'Omen of Dextral Necromancy', currency: 'desecrated' },
      { id: 'desecrated_sinistral', name: 'Omen of Sinistral Necromancy', currency: 'desecrated' },
      { id: 'desecrated_blackblooded', name: 'Omen of the Blackblooded', currency: 'desecrated' },
      { id: 'desecrated_liege', name: 'Omen of the Liege', currency: 'desecrated' },
      { id: 'desecrated_sovereign', name: 'Omen of the Sovereign', currency: 'desecrated' }
    ];
    
    // Item categories
    const ITEM_CATEGORIES = {
      'shields': {
        label: 'Shields',
        subtypes: [
          { id: 6, name: 'STR + INT' },
          { id: 7, name: 'STR' },
          { id: 8, name: 'STR + DEX' }
        ]
      },
      'helmets': {
        label: 'Helmets',
        subtypes: [
          { id: 10, name: 'STR + INT' },
          { id: 11, name: 'INT' },
          { id: 12, name: 'DEX + INT' },
          { id: 13, name: 'STR' },
          { id: 14, name: 'DEX' },
          { id: 15, name: 'STR + DEX' }
        ]
      },
      'boots': {
        label: 'Boots',
        subtypes: [
          { id: 17, name: 'STR + INT' },
          { id: 18, name: 'INT' },
          { id: 19, name: 'DEX + INT' },
          { id: 20, name: 'STR' },
          { id: 21, name: 'DEX' },
          { id: 22, name: 'STR + DEX' }
        ]
      },
      'gloves': {
        label: 'Gloves',
        subtypes: [
          { id: 25, name: 'STR + INT' },
          { id: 26, name: 'INT' },
          { id: 27, name: 'DEX + INT' },
          { id: 28, name: 'STR' },
          { id: 29, name: 'DEX' },
          { id: 30, name: 'STR + DEX' }
        ]
      },
      'body_armours': {
        label: 'Body Armours',
        subtypes: [
          { id: 31, name: 'STR' },
          { id: 32, name: 'STR + INT' },
          { id: 33, name: 'STR + DEX' },
          { id: 34, name: 'INT' },
          { id: 35, name: 'DEX' },
          { id: 36, name: 'DEX + INT' }
        ]
      }
    };
    
    const SIMPLE_ITEMS = [
      { id: 0, name: 'Bows' },
      { id: 1, name: 'Crossbows' },
      { id: 2, name: 'Quivers' },
      { id: 3, name: 'One Hand Maces' },
      { id: 4, name: 'Amulets' },
      { id: 5, name: 'Spears' },
      { id: 9, name: 'Two Hand Maces' },
      { id: 16, name: 'Sceptres' },
      { id: 23, name: 'Bucklers' },
      { id: 24, name: 'Rings' },
      { id: 37, name: 'Wands' },
      { id: 38, name: 'Quarterstaves' },
      { id: 39, name: 'Foci' },
      { id: 40, name: 'Staves' }
    ];
    
    // Initialize WASM
    statusEl.innerHTML = '<span class="warning">‚è≥ Loading WASM...</span>';
    
    if (typeof Module === 'undefined') {
      statusEl.innerHTML = '<span class="error">‚ùå poe2.js failed to load. Is server running on port 5173?</span>';
    } else {
      Module.onRuntimeInitialized = () => {
        try {
          api = {
            itemCount: Module.cwrap('get_items_count', 'number', []),
            modCountNormal: Module.cwrap('get_modifiers_normal_count', 'number', []),
            modCountDesecrated: Module.cwrap('get_modifiers_desecrated_count', 'number', []),
            modCountEssence: Module.cwrap('get_modifiers_essence_count', 'number', []),
            modCountPerfectEssence: Module.cwrap('get_modifiers_perfect_essence_count', 'number', []),
            modName: Module.cwrap('get_modifier_name', 'string', ['number', 'number']),
            modDescription: Module.cwrap('get_modifier_group', 'string', ['number', 'number']),
            modGroup: Module.cwrap('get_modifier_name', 'string', ['number', 'number']), // Family/group name
            modTierCount: Module.cwrap('get_modifier_tier_count', 'number', ['number', 'number']),
            modTierName: Module.cwrap('get_modifier_tier_name', 'string', ['number', 'number', 'number']),
            modTierLevelReq: Module.cwrap('get_modifier_tier_level_req', 'number', ['number', 'number', 'number']),
            modTierWeight: Module.cwrap('get_modifier_tier_weight', 'number', ['number', 'number', 'number']),
            modTierValueCount: Module.cwrap('get_modifier_tier_value_count', 'number', ['number', 'number', 'number']),
            modTierValueMin: Module.cwrap('get_modifier_tier_value_min', 'number', ['number', 'number', 'number', 'number']),
            modTierValueMax: Module.cwrap('get_modifier_tier_value_max', 'number', ['number', 'number', 'number', 'number']),
            // Item-specific modifier lookup functions
            itemPrefixCount: Module.cwrap('get_item_prefix_count', 'number', ['number', 'number']),
            itemSuffixCount: Module.cwrap('get_item_suffix_count', 'number', ['number', 'number']),
            itemPrefixSource: Module.cwrap('get_item_prefix_source', 'number', ['number', 'number', 'number']),
            itemPrefixIndex: Module.cwrap('get_item_prefix_index', 'number', ['number', 'number', 'number']),
            itemPrefixMaxTier: Module.cwrap('get_item_prefix_max_tier', 'number', ['number', 'number', 'number']),
            itemSuffixSource: Module.cwrap('get_item_suffix_source', 'number', ['number', 'number', 'number']),
            itemSuffixIndex: Module.cwrap('get_item_suffix_index', 'number', ['number', 'number', 'number']),
            itemSuffixMaxTier: Module.cwrap('get_item_suffix_max_tier', 'number', ['number', 'number', 'number'])
          };
          
          const c = api.itemCount();
          statusEl.innerHTML = `<span class="status-success">‚úÖ Ready</span> <span>${c} items ‚Ä¢ 1337 modifiers ‚Ä¢ 5471 tiers</span>`;
          
          // Populate item grid
          SIMPLE_ITEMS.forEach(item => {
            const box = document.createElement('div');
            box.className = 'item-box';
            box.textContent = item.name;
            box.onclick = () => selectItem('simple', item.id, box);
            itemGrid.appendChild(box);
          });
          
          Object.keys(ITEM_CATEGORIES).forEach(key => {
            const cat = ITEM_CATEGORIES[key];
            const box = document.createElement('div');
            box.className = 'item-box';
            box.textContent = cat.label;
            box.onclick = () => selectItem('category', key, box);
            itemGrid.appendChild(box);
          });
          
          // Populate currency grid
          renderCurrencyGrid();
          renderOmenList();
        } catch(e) {
          statusEl.innerHTML = `<span class="error">‚ùå Error: ${e.message}</span>`;
        }
      };
    }
    
    // Currency functions
    function renderCurrencyGrid() {
      const currencyGrid = document.getElementById('currencyGrid');
      if (!currencyGrid) return;
      
      currencyGrid.innerHTML = '';
      CURRENCIES.forEach(currency => {
        const container = document.createElement('div');
        container.style.display = 'flex';
        container.style.flexDirection = 'column';
        container.style.gap = '0.5rem';
        
        const item = document.createElement('div');
        item.className = 'currency-item';
        if (enabledCurrencies.has(currency.id)) {
          item.classList.add('enabled');
        } else {
          item.classList.add('disabled');
        }
        
        item.onclick = () => toggleCurrency(currency.id);
        
        const checkbox = document.createElement('div');
        checkbox.className = 'currency-checkbox';
        if (enabledCurrencies.has(currency.id)) {
          checkbox.textContent = '‚úì';
        }
        
        const name = document.createElement('div');
        name.className = 'currency-name';
        name.textContent = currency.name;
        
        item.appendChild(checkbox);
        item.appendChild(name);
        container.appendChild(item);
        
        // Add tier dropdown if currency has tiers and is enabled
        if (currency.tiers && currency.tiers.length > 0 && enabledCurrencies.has(currency.id)) {
          const tiersDiv = document.createElement('div');
          tiersDiv.className = 'currency-tiers';
          
          // Dropdown header
          const dropdownHeader = document.createElement('div');
          dropdownHeader.className = 'tier-dropdown-header';
          
          const arrow = document.createElement('span');
          arrow.className = 'tier-dropdown-arrow';
          arrow.textContent = '‚ñ∂';
          
          const label = document.createElement('span');
          label.className = 'tier-dropdown-label';
          const enabledCount = currency.tiers.filter(tier => 
            !disabledCurrencyTiers.has(`${currency.id}_${tier}`)
          ).length;
          label.textContent = `Tiers (${enabledCount}/${currency.tiers.length})`;
          
          dropdownHeader.appendChild(arrow);
          dropdownHeader.appendChild(label);
          
          // Dropdown content
          const dropdownContent = document.createElement('div');
          dropdownContent.className = 'tier-dropdown-content';
          
          currency.tiers.forEach(tier => {
            const tierKey = `${currency.id}_${tier}`;
            const tierItem = document.createElement('div');
            tierItem.className = 'tier-item';
            if (!disabledCurrencyTiers.has(tierKey)) {
              tierItem.classList.add('enabled');
            }
            
            tierItem.onclick = (e) => {
              e.stopPropagation();
              toggleCurrencyTier(tierKey, currency.id);
            };
            
            const tierCheckbox = document.createElement('div');
            tierCheckbox.className = 'tier-checkbox';
            if (!disabledCurrencyTiers.has(tierKey)) {
              tierCheckbox.textContent = '‚úì';
            }
            
            const tierName = document.createElement('div');
            tierName.className = 'tier-name';
            tierName.textContent = tier;
            
            tierItem.appendChild(tierCheckbox);
            tierItem.appendChild(tierName);
            dropdownContent.appendChild(tierItem);
          });
          
          dropdownHeader.onclick = (e) => {
            e.stopPropagation();
            arrow.classList.toggle('open');
            dropdownContent.classList.toggle('open');
          };
          
          tiersDiv.appendChild(dropdownHeader);
          tiersDiv.appendChild(dropdownContent);
          container.appendChild(tiersDiv);
        }
        
        currencyGrid.appendChild(container);
      });
    }
    
    function toggleCurrency(currencyId) {
      if (enabledCurrencies.has(currencyId)) {
        enabledCurrencies.delete(currencyId);
      } else {
        enabledCurrencies.add(currencyId);
      }
      renderCurrencyGrid();
      renderOmenList();
    }
    
    function toggleCurrencyTier(tierKey, currencyId) {
      if (disabledCurrencyTiers.has(tierKey)) {
        disabledCurrencyTiers.delete(tierKey);
      } else {
        disabledCurrencyTiers.add(tierKey);
      }
      
      // Update only the specific currency's tier display without re-rendering everything
      const currency = CURRENCIES.find(c => c.id === currencyId);
      if (currency) {
        // Update the tier item
        const tierItems = document.querySelectorAll('.tier-item');
        tierItems.forEach(item => {
          const tierName = item.querySelector('.tier-name');
          if (tierName) {
            const tier = tierName.textContent;
            const key = `${currencyId}_${tier}`;
            if (key === tierKey) {
              const checkbox = item.querySelector('.tier-checkbox');
              if (disabledCurrencyTiers.has(tierKey)) {
                item.classList.remove('enabled');
                checkbox.textContent = '';
              } else {
                item.classList.add('enabled');
                checkbox.textContent = '‚úì';
              }
            }
          }
        });
        
        // Update the counter in the header
        const enabledCount = currency.tiers.filter(tier => 
          !disabledCurrencyTiers.has(`${currencyId}_${tier}`)
        ).length;
        const headers = document.querySelectorAll('.tier-dropdown-header');
        headers.forEach(header => {
          const label = header.querySelector('.tier-dropdown-label');
          if (label && label.textContent.startsWith('Tiers')) {
            const parent = header.closest('.currency-tiers');
            if (parent) {
              // Check if this header belongs to the right currency by checking its position
              const currencyContainer = parent.closest('div');
              const currencyName = currencyContainer.querySelector('.currency-name');
              if (currencyName && currencyName.textContent === currency.name) {
                label.textContent = `Tiers (${enabledCount}/${currency.tiers.length})`;
              }
            }
          }
        });
      }
    }
    
    function enableAllCurrencies() {
      enabledCurrencies = new Set(CURRENCIES.map(c => c.id));
      disabledCurrencyTiers.clear();
      renderCurrencyGrid();
      renderOmenList();
    }
    
    function disableAllCurrencies() {
      enabledCurrencies.clear();
      renderCurrencyGrid();
      renderOmenList();
    }
    
    // Omen functions
    function renderOmenList() {
      const omenSection = document.getElementById('omenSection');
      const omenList = document.getElementById('omenList');
      if (!omenSection || !omenList) return;
      
      // Get omens for enabled currencies
      const availableOmens = OMENS.filter(omen => enabledCurrencies.has(omen.currency));
      
      omenList.innerHTML = '';
      
      if (availableOmens.length === 0) {
        omenList.innerHTML = '<div style="text-align: center; color: var(--text-muted); font-size: 0.65rem; padding: 0.5rem;">No currencies selected</div>';
        return;
      }
      
      // Group omens by currency
      const omensByCurrency = {};
      availableOmens.forEach(omen => {
        if (!omensByCurrency[omen.currency]) {
          omensByCurrency[omen.currency] = [];
        }
        omensByCurrency[omen.currency].push(omen);
      });
      
      // Render each currency group
      Object.keys(omensByCurrency).forEach(currencyId => {
        const omens = omensByCurrency[currencyId];
        const currency = CURRENCIES.find(c => c.id === currencyId);
        if (!currency) return;
        
        const groupDiv = document.createElement('div');
        groupDiv.className = 'omen-currency-group';
        
        // Dropdown header
        const dropdownHeader = document.createElement('div');
        dropdownHeader.className = 'omen-dropdown-header';
        
        const arrow = document.createElement('span');
        arrow.className = 'omen-dropdown-arrow';
        arrow.textContent = '‚ñ∂';
        
        const label = document.createElement('span');
        label.className = 'omen-dropdown-label';
        const enabledCount = omens.filter(omen => !disabledOmens.has(omen.id)).length;
        label.textContent = `${currency.name} (${enabledCount}/${omens.length})`;
        
        dropdownHeader.appendChild(arrow);
        dropdownHeader.appendChild(label);
        
        // Dropdown content
        const dropdownContent = document.createElement('div');
        dropdownContent.className = 'omen-dropdown-content';
        
        omens.forEach(omen => {
          const item = document.createElement('div');
          item.className = 'omen-item';
          if (!disabledOmens.has(omen.id)) {
            item.classList.add('enabled');
          }
          
          item.onclick = (e) => {
            e.stopPropagation();
            toggleOmen(omen.id, currencyId);
          };
          
          const checkbox = document.createElement('div');
          checkbox.className = 'omen-checkbox';
          if (!disabledOmens.has(omen.id)) {
            checkbox.textContent = '‚úì';
          }
          
          const name = document.createElement('div');
          name.className = 'omen-name';
          name.textContent = omen.name;
          
          item.appendChild(checkbox);
          item.appendChild(name);
          dropdownContent.appendChild(item);
        });
        
        dropdownHeader.onclick = (e) => {
          e.stopPropagation();
          arrow.classList.toggle('open');
          dropdownContent.classList.toggle('open');
        };
        
        groupDiv.appendChild(dropdownHeader);
        groupDiv.appendChild(dropdownContent);
        omenList.appendChild(groupDiv);
      });
    }
    
    function toggleOmen(omenId, currencyId) {
      if (disabledOmens.has(omenId)) {
        disabledOmens.delete(omenId);
      } else {
        disabledOmens.add(omenId);
      }
      
      // Update only the specific omen item without re-rendering
      const omenItems = document.querySelectorAll('.omen-item');
      omenItems.forEach(item => {
        const name = item.querySelector('.omen-name');
        if (name) {
          const omen = OMENS.find(o => o.name === name.textContent);
          if (omen && omen.id === omenId) {
            const checkbox = item.querySelector('.omen-checkbox');
            if (disabledOmens.has(omenId)) {
              item.classList.remove('enabled');
              checkbox.textContent = '';
            } else {
              item.classList.add('enabled');
              checkbox.textContent = '‚úì';
            }
          }
        }
      });
      
      // Update the counter in the header
      const currency = CURRENCIES.find(c => c.id === currencyId);
      if (currency) {
        const omensForCurrency = OMENS.filter(o => o.currency === currencyId);
        const enabledCount = omensForCurrency.filter(o => !disabledOmens.has(o.id)).length;
        
        const headers = document.querySelectorAll('.omen-dropdown-header');
        headers.forEach(header => {
          const label = header.querySelector('.omen-dropdown-label');
          if (label && label.textContent.startsWith(currency.name)) {
            label.textContent = `${currency.name} (${enabledCount}/${omensForCurrency.length})`;
          }
        });
      }
    }
    
    function selectItem(type, value, element) {
      document.querySelectorAll('#itemGrid .item-box').forEach(box => box.classList.remove('selected'));
      element.classList.add('selected');
      
      if (type === 'category') {
        const category = ITEM_CATEGORIES[value];
        subtypeLabel.textContent = category.label;
        subtypeGrid.innerHTML = '';
        
        category.subtypes.forEach(subtype => {
          const box = document.createElement('div');
          box.className = 'item-box';
          box.textContent = subtype.name;
          box.onclick = () => selectSubtype(subtype.id, box);
          subtypeGrid.appendChild(box);
        });
        
        subtypeSection.style.display = 'block';
        modeRaritySection.style.display = 'none';
      } else {
        subtypeSection.style.display = 'none';
        currentItemId = value;
        modeRaritySection.style.display = 'block';
        
        // Reload modifiers if we're already in modifier selection view
        if (modifiersPanel.style.display === 'flex') {
          loadModifiers();
        }
      }
    }
    
    function selectSubtype(itemId, element) {
      document.querySelectorAll('#subtypeGrid .item-box').forEach(box => box.classList.remove('selected'));
      element.classList.add('selected');
      currentItemId = itemId;
      console.log('Selected subtype - Item ID:', itemId, 'Item name:', element.textContent);
      modeRaritySection.style.display = 'block';
      
      // Reload modifiers if we're already in modifier selection view
      if (modifiersPanel.style.display === 'flex') {
        loadModifiers();
      }
    }
    
    function selectMode(mode) {
      currentMode = mode;
      
      console.log('selectMode called - currentItemId:', currentItemId);
      
      // Hide mode selection boxes and show summary
      modeSelectionBoxes.style.display = 'none';
      selectionSummary.style.display = 'block';
      modeBadge.textContent = mode === 'scratch' ? 'From Scratch' : 'Improve';
      
      // Set default rarity based on mode
      if (mode === 'improve') {
        currentRarity = 'magic'; // Default to magic for improve mode
      } else {
        currentRarity = 'normal'; // Default to normal for scratch mode
      }
      
      raritySection.style.display = 'none';
      rarityLabelSummary.style.display = 'inline';
      document.getElementById('rarityDropdownInline').style.display = 'inline';
      document.getElementById('rarityDropdownInline').value = currentRarity;
      document.getElementById('ilvlLabelSummary').style.display = 'inline';
      document.getElementById('ilvlInputInline').style.display = 'inline';
      document.getElementById('ilvlInputInline').value = currentItemLevel;
      
      // Show currency selection section
      document.getElementById('currencySelectionSection').style.display = 'block';
      
      loadModifiers();
      modifiersPanel.style.display = 'flex';
      selectedPanel.style.display = 'flex';
      updateDisplayHeader();
    }
    
    function selectRarity() {
      const dropdown = document.getElementById('rarityDropdown');
      const rarity = dropdown.value;
      
      if (!rarity) return;
      
      currentRarity = rarity;
      
      // Hide rarity selection and show ilvl section
      raritySection.style.display = 'none';
      document.getElementById('ilvlSection').style.display = 'block';
    }
    
    function onItemLevelChange() {
      const input = document.getElementById('ilvlInput');
      currentItemLevel = parseInt(input.value) || 82;
      
      // Update summary and show inline controls
      rarityLabelSummary.style.display = 'inline';
      document.getElementById('rarityDropdownInline').style.display = 'inline';
      document.getElementById('rarityDropdownInline').value = currentRarity;
      document.getElementById('ilvlLabelSummary').style.display = 'inline';
      document.getElementById('ilvlInputInline').style.display = 'inline';
      document.getElementById('ilvlInputInline').value = currentItemLevel;
      document.getElementById('ilvlSection').style.display = 'none';
      
      loadModifiers();
      modifiersPanel.style.display = 'flex';
      selectedPanel.style.display = 'flex';
      updateDisplayHeader();
    }
    
    function onItemLevelChangeInline() {
      const input = document.getElementById('ilvlInputInline');
      currentItemLevel = parseInt(input.value) || 82;
      loadModifiers();
      updateDisplayHeader();
    }
    
    function onRarityChange() {
      const dropdown = document.getElementById('rarityDropdownInline');
      currentRarity = dropdown.value;
      updateDisplayHeader();
    }
    
    function changeSelection() {
      // Hide panels and reset to mode selection
      modifiersPanel.style.display = 'none';
      selectedPanel.style.display = 'none';
      selectionSummary.style.display = 'none';
      raritySection.style.display = 'none';
      document.getElementById('ilvlSection').style.display = 'none';
      modeSelectionBoxes.style.display = 'block';
      document.getElementById('rarityDropdownInline').style.display = 'none';
      document.getElementById('ilvlLabelSummary').style.display = 'none';
      document.getElementById('ilvlInputInline').style.display = 'none';
      
      // Reset selections
      selectedModifiers = { prefixes: [], suffixes: [] };
      currentMode = null;
      currentRarity = null;
      currentItemLevel = 82;
      document.getElementById('ilvlInput').value = 82;
      document.getElementById('ilvlInputInline').value = 82;
    }
    

    
    function updateDisplayHeader() {
      if (currentMode && currentRarity) {
        displayMode.textContent = currentMode === 'scratch' ? 'Mode: Start from Scratch' : 'Mode: Improve Existing';
        
        if (currentRarity === 'normal') {
          displayRarity.textContent = 'Normal Item';
        } else if (currentRarity === 'magic') {
          displayRarity.textContent = 'Magic Item';
        } else {
          displayRarity.textContent = 'Rare Item';
        }
        displayRarity.className = `selected-rarity ${currentRarity}`;
        updateModifierCount();
      }
    }
    
    function updateModifierCount() {
      const total = selectedModifiers.prefixes.length + selectedModifiers.suffixes.length;
      let max = 6;
      
      if (currentRarity === 'magic' && !isExpandedMode) {
        max = 2; // Magic: max 1 prefix + 1 suffix existing (before expanding)
      } else {
        max = 6; // Expanded or Rare: 3 prefix + 3 suffix
      }
      
      displayCount.textContent = `${total}/${max}`;
      
      // Update prefix counter
      const prefixCounter = document.getElementById('prefixCounter');
      const prefixCount = selectedModifiers.prefixes.length;
      let prefixMax = 3;
      
      if (currentRarity === 'magic' && !isExpandedMode) {
        prefixMax = 1;
      }
      
      prefixCounter.textContent = `(${prefixCount}/${prefixMax})`;
      prefixCounter.style.color = prefixCount >= prefixMax ? '#ff4444' : '#888';
      
      // Update suffix counter
      const suffixCounter = document.getElementById('suffixCounter');
      const suffixCount = selectedModifiers.suffixes.length;
      let suffixMax = 3;
      
      if (currentRarity === 'magic' && !isExpandedMode) {
        suffixMax = 1;
      }
      
      suffixCounter.textContent = `(${suffixCount}/${suffixMax})`;
      suffixCounter.style.color = suffixCount >= suffixMax ? '#ff4444' : '#888';
    }
    
    function clearAllSelections() {
      // Reset all state
      selectedModifiers = { prefixes: [], suffixes: [] };
      existingModifiers = { prefixes: [], suffixes: [] };
      isExpandedMode = false;
      
      // Reset UI
      const actionBtn = document.getElementById('actionBtn');
      const stepDescription = document.getElementById('stepDescription');
      
      actionBtn.textContent = 'Continue: Add More Modifiers ‚Üí';
      actionBtn.onclick = toggleSelectionMode;
      stepDescription.textContent = 'Select the modifiers already on your item (0-2 max: 1 prefix and 1 suffix)';
      
      // Reload modifiers to reset everything
      loadModifiers();
      updateSelectedDisplay();
      updateModifierCount();
    }
    
    function exportItem() {
      const totalModifiers = selectedModifiers.prefixes.length + selectedModifiers.suffixes.length;
      if (totalModifiers === 0) {
        alert('No modifiers selected. Please select modifiers before exporting.');
        return;
      }
      
      // Separate existing modifiers from desired modifiers
      const existingMods = [];
      const desiredMods = [];
      
      const collectModifier = (mod, type) => {
        const dropdown = document.getElementById(`${type}_tier_${mod.source}_${mod.index}`);
        const selectedTier = dropdown ? parseInt(dropdown.value) : 0;
        
        return {
          source: mod.source,
          index: mod.index,
          tier: selectedTier,
          type: type,
          description: mod.description
        };
      };
      
      // Check if each modifier is existing or desired
      selectedModifiers.prefixes.forEach(mod => {
        const isExisting = existingModifiers.prefixes.some(em => em.key === mod.key);
        const modData = collectModifier(mod, 'prefix');
        if (isExisting) {
          existingMods.push(modData);
        } else {
          desiredMods.push(modData);
        }
      });
      
      selectedModifiers.suffixes.forEach(mod => {
        const isExisting = existingModifiers.suffixes.some(em => em.key === mod.key);
        const modData = collectModifier(mod, 'suffix');
        if (isExisting) {
          existingMods.push(modData);
        } else {
          desiredMods.push(modData);
        }
      });
      
      const exportData = {
        itemId: currentItemId,
        itemName: currentItemId !== null ? Module.ccall('get_item_name', 'string', ['number'], [currentItemId]) : null,
        mode: currentMode,
        rarity: currentRarity,
        existingModifiers: existingMods,
        desiredModifiers: desiredMods
      };
      
      const jsonStr = JSON.stringify(exportData, null, 2);
      
      // Copy to clipboard
      navigator.clipboard.writeText(jsonStr).then(() => {
        alert('Item configuration copied to clipboard!');
      }).catch(err => {
        // Fallback for older browsers
        const textarea = document.createElement('textarea');
        textarea.value = jsonStr;
        document.body.appendChild(textarea);
        textarea.select();
        document.execCommand('copy');
        document.body.removeChild(textarea);
        alert('Item configuration copied to clipboard!');
      });
      
      console.log('Exported item:', exportData);
    }
    
    function showImportDialog() {
      const modal = document.getElementById('importModal');
      const textarea = document.getElementById('importTextarea');
      modal.style.display = 'flex';
      textarea.value = '';
      textarea.focus();
    }
    
    function closeImportDialog() {
      const modal = document.getElementById('importModal');
      modal.style.display = 'none';
    }
    
    function processImport() {
      const textarea = document.getElementById('importTextarea');
      const itemText = textarea.value.trim();
      
      if (!itemText) {
        alert('Please paste item text first!');
        return;
      }
      
      try {
        // Check if input is JSON
        if (itemText.startsWith('{')) {
          importFromJSON(itemText);
        } else {
          parseAndImportItem(itemText);
        }
        closeImportDialog();
      } catch (err) {
        alert('Failed to parse item: ' + err.message + '\n\nMake sure you copied the full item text from Path of Exile 2 or valid JSON export.');
        console.error('Import error:', err);
      }
    }
    
    function importFromJSON(jsonText) {
      const data = JSON.parse(jsonText);
      
      if (!data.itemId || !data.modifiers) {
        throw new Error('Invalid JSON format. Missing required fields: itemId, modifiers');
      }
      
      // Set item
      currentItemId = data.itemId;
      
      // Set mode and rarity (with defaults)
      currentMode = data.mode || 'scratch';
      currentRarity = data.rarity || 'normal';
      
      // Import currencies configuration (blacklist approach)
      if (data.disabledCurrencies || data.disabledCurrencyTiers || data.disabledOmens) {
        // Reset to default (all enabled)
        enabledCurrencies.clear();
        CURRENCIES.forEach(currency => enabledCurrencies.add(currency.id));
        disabledCurrencyTiers.clear();
        disabledOmens.clear();
        
        // Apply disabled currencies
        if (data.disabledCurrencies) {
          data.disabledCurrencies.forEach(currencyId => {
            enabledCurrencies.delete(currencyId);
          });
        }
        
        // Apply disabled currency tiers
        if (data.disabledCurrencyTiers) {
          data.disabledCurrencyTiers.forEach(tierKey => {
            disabledCurrencyTiers.add(tierKey);
          });
        }
        
        // Apply disabled omens
        if (data.disabledOmens) {
          data.disabledOmens.forEach(omenId => {
            disabledOmens.add(omenId);
          });
        }
        
        // Re-render UI to reflect imported state
        renderCurrencyGrid();
        renderOmenList();
      }
      
      // Update UI to reflect mode and rarity
      if (currentMode === 'scratch') {
        document.getElementById('modeBadge').textContent = 'From Scratch';
      } else {
        document.getElementById('modeBadge').textContent = 'Improve';
      }
      document.getElementById('rarityDropdownInline').value = currentRarity;
      document.getElementById('rarityDropdownInline').style.display = 'inline';
      document.getElementById('rarityLabelSummary').style.display = 'inline';
      document.getElementById('ilvlLabelSummary').style.display = 'inline';
      document.getElementById('ilvlInputInline').style.display = 'inline';
      document.getElementById('ilvlInputInline').value = currentItemLevel;
      
      // Show panels
      document.getElementById('modeRaritySection').style.display = 'block';
      document.getElementById('selectionSummary').style.display = 'block';
      document.getElementById('modeSelectionBoxes').style.display = 'none';
      document.getElementById('modifiersPanel').style.display = 'flex';
      document.getElementById('selectedPanel').style.display = 'flex';
      
      // Clear existing selections
      selectedModifiers = { prefixes: [], suffixes: [] };
      
      // Load modifiers for this item
      loadModifiers();
      
      // Wait a bit for modifiers to load, then apply selections
      setTimeout(() => {
        data.modifiers.forEach(mod => {
          const type = mod.type || (mod.description && mod.description.includes('+') ? 'suffix' : 'prefix');
          const array = type === 'prefix' ? selectedModifiers.prefixes : selectedModifiers.suffixes;
          const key = `${mod.source}_${mod.index}`;
          
          // Get modifier details from WASM
          const modDesc = api.modDescription(mod.source, mod.index);
          const tierCount = api.modTierCount(mod.source, mod.index);
          
          array.push({
            key: key,
            source: mod.source,
            index: mod.index,
            type: type,
            description: modDesc,
            tierCount: tierCount
          });
          
          // Update checkbox and dropdown in UI
          const checkboxId = `${type}_${mod.source}_${mod.index}`;
          const checkbox = document.getElementById(checkboxId);
          if (checkbox) {
            checkbox.checked = true;
            const parent = checkbox.closest('.modifier-item');
            if (parent) {
              parent.classList.add('selected');
              const dropdown = parent.querySelector('.tier-dropdown');
              if (dropdown) {
                dropdown.style.display = 'block';
                if (mod.tier !== undefined) {
                  dropdown.value = mod.tier;
                }
              }
            }
          }
        });
        
        // Update UI
        updateSelectedDisplay();
        updateModifierCount();
        
        console.log('Imported from JSON:', data);
      }, 100);
    }
    
    function parseAndImportItem(itemText) {
      const lines = itemText.split('\n').map(l => l.trim()).filter(l => l);
      
      // Parse item class
      let itemClass = null;
      let rarity = null;
      let itemLevel = null;
      const parsedModifiers = { prefixes: [], suffixes: [] };
      
      for (let i = 0; i < lines.length; i++) {
        const line = lines[i];
        
        // Parse Item Class
        if (line.startsWith('Item Class:')) {
          itemClass = line.replace('Item Class:', '').trim();
        }
        
        // Parse Rarity
        if (line.startsWith('Rarity:')) {
          const rarityText = line.replace('Rarity:', '').trim().toLowerCase();
          if (rarityText === 'normal') rarity = 'normal';
          else if (rarityText === 'magic') rarity = 'magic';
          else if (rarityText === 'rare') rarity = 'rare';
        }
        
        // Parse Item Level
        if (line.startsWith('Item Level:')) {
          itemLevel = parseInt(line.replace('Item Level:', '').trim());
        }
        
        // Parse modifiers - skip implicit modifiers
        if (line.startsWith('{ Prefix Modifier') || line.startsWith('{ Suffix Modifier')) {
          const isPrefix = line.startsWith('{ Prefix');
          const type = isPrefix ? 'prefixes' : 'suffixes';
          
          // Extract modifier name and tier
          const nameMatch = line.match(/"([^"]+)"/);
          const tierMatch = line.match(/Tier:\s*(\d+)/);
          
          if (nameMatch) {
            const tierName = nameMatch[1];
            const tier = tierMatch ? parseInt(tierMatch[1]) : null;
            
            // Extract the actual modifier description from next line(s)
            // Stop at the next { or --- separator
            const descriptions = [];
            for (let j = i + 1; j < lines.length; j++) {
              const nextLine = lines[j];
              if (nextLine.startsWith('{') || nextLine.startsWith('---')) break;
              if (nextLine && !nextLine.startsWith('Sockets') && !nextLine.startsWith('Quality')) {
                descriptions.push(nextLine);
              }
            }
            
            console.log(`Parsed ${type.slice(0, -2)} "${tierName}" (T${tier}):`, descriptions);
            
            parsedModifiers[type].push({
              tierName: tierName,
              tier: tier,
              descriptions: descriptions
            });
          }
        }
      }
      
      console.log('=== PARSED ITEM ===');
      console.log('Item Class:', itemClass);
      console.log('Rarity:', rarity);
      console.log('Item Level:', itemLevel);
      console.log('Prefixes:', parsedModifiers.prefixes);
      console.log('Suffixes:', parsedModifiers.suffixes);
      console.log('==================');
      
      if (!rarity) {
        throw new Error('Could not parse item rarity');
      }
      
      // Auto-detect item ID from parsed item class (prioritize this over current selection)
      let itemId = null;
      
      // If item class was parsed, try to auto-detect the item ID
      if (itemClass) {
        itemId = findItemIdByClass(itemClass);
        if (itemId) {
          console.log(`Auto-detected item ID ${itemId} from class "${itemClass}"`);
        } else {
          console.warn(`Unknown item class: ${itemClass}, will use manual selection if available`);
        }
      }
      
      // Fall back to manually selected item if auto-detection failed
      if (!itemId) {
        itemId = currentItemId;
      }
      
      if (!itemId) {
        throw new Error('Could not detect item type. Please select the item base manually in Step 1 before importing.');
      }
      
      // Now match modifiers from our database using the detected/selected item
      const matchedModifiers = matchModifiersToDatabase(itemId, parsedModifiers);
      
      if (matchedModifiers.prefixes.length === 0 && matchedModifiers.suffixes.length === 0) {
        throw new Error('Could not match any modifiers to the database');
      }
      
      // Apply the import using the already-selected item base
      applyImportedItem(itemId, rarity, matchedModifiers, parsedModifiers);
    }
    
    function findItemIdByClass(itemClass) {
      // Normalize the item class name
      const normalized = itemClass.toLowerCase().trim();
      
      // Map common item class variations
      const classMap = {
        'foci': 39,
        'focus': 39,
        'boots': 17,
        'gloves': 18,
        'helmets': 11,
        'helmet': 11,
        'body armours': 20,
        'body armour': 20,
        'amulets': 4,
        'amulet': 4,
        'rings': 24,
        'ring': 24,
        'belts': 25,
        'belt': 25,
        'quivers': 2,
        'quiver': 2,
        'bows': 0,
        'bow': 0,
        'crossbows': 1,
        'crossbow': 1,
        'wands': 37,
        'wand': 37,
        'sceptres': 16,
        'sceptre': 16,
        'staves': 40,
        'staff': 40,
        'quarterstaves': 38,
        'quarterstaff': 38,
        'one hand maces': 3,
        'two hand maces': 9,
        'spears': 5,
        'spear': 5,
        'bucklers': 23,
        'buckler': 23
      };
      
      return classMap[normalized] || null;
    }
    
    function matchModifiersToDatabase(itemId, parsedModifiers) {
      const matched = { prefixes: [], suffixes: [] };
      
      console.log('=== MATCHING MODIFIERS ===');
      console.log('Item ID:', itemId);
      
      // Load all available modifiers for this item
      // Prioritize sources based on tier names: if tier name contains "Essence", check ESSENCE first
      const hasEssence = parsedModifiers.prefixes.some(p => p.tierName && p.tierName.includes('Essence')) ||
                        parsedModifiers.suffixes.some(s => s.tierName && s.tierName.includes('Essence'));
      const hasDesecrated = parsedModifiers.prefixes.some(p => p.tierName && p.tierName.includes('Desecrated')) ||
                           parsedModifiers.suffixes.some(s => s.tierName && s.tierName.includes('Desecrated'));
      
      // Prioritize source order based on detected tier names
      let sources;
      if (hasEssence) {
        sources = [2, 0, 1]; // Essence first, then Normal, then Desecrated
      } else if (hasDesecrated) {
        sources = [1, 0, 2]; // Desecrated first, then Normal, then Essence
      } else {
        sources = [0, 1, 2]; // Normal first (default)
      }
      
      console.log('Source priority:', sources.map(s => ['Normal', 'Desecrated', 'Essence'][s]).join(' ‚Üí '));
      
      // Match prefixes
      console.log('\n--- MATCHING PREFIXES ---');
      for (const parsed of parsedModifiers.prefixes) {
        const match = findModifierInDatabase(itemId, 'prefix', parsed, sources);
        if (match) {
          matched.prefixes.push(match);
        } else {
          console.warn('‚ùå Could not match prefix:', parsed);
        }
      }
      
      // Match suffixes
      console.log('\n--- MATCHING SUFFIXES ---');
      for (const parsed of parsedModifiers.suffixes) {
        const match = findModifierInDatabase(itemId, 'suffix', parsed, sources);
        if (match) {
          matched.suffixes.push(match);
        } else {
          console.warn('‚ùå Could not match suffix:', parsed);
        }
      }
      
      console.log('\n=== MATCHING COMPLETE ===');
      console.log('Matched:', matched.prefixes.length, 'prefixes,', matched.suffixes.length, 'suffixes');
      
      // Count how many modifiers couldn't be matched
      const unmatchedCount = (parsedModifiers.prefixes.length - matched.prefixes.length) + 
                             (parsedModifiers.suffixes.length - matched.suffixes.length);
      
      if (unmatchedCount > 0) {
        console.warn(`‚ö†Ô∏è ${unmatchedCount} modifier(s) could not be matched - they may not be available for the selected item base`);
      }
      
      console.log('=======================\n');
      
      return matched;
    }
    
    function findModifierInDatabase(itemId, type, parsedMod, sources) {
      console.log(`Searching for ${type}:`, parsedMod);
      
      // Skip tier name matching as it's unreliable - go straight to description matching
      // (POE2 tier names don't always match our database tier names)
      
      // Try description matching
      console.log(`  Trying description matching...`);
      console.log(`  Looking for modifier with ${parsedMod.descriptions.length} line(s):`, parsedMod.descriptions);
      
      for (const source of sources) {
        const modCount = source === 0 ? api.modCountNormal() : source === 1 ? api.modCountDesecrated() : source === 2 ? api.modCountEssence() : api.modCountPerfectEssence();
        const count = modCount;
        
        for (let i = 0; i < count; i++) {
          const modSrc = source;
          const modIdx = i;
          
          // Use full tier count since item-specific filtering is not implemented
          const tierCount = api.modTierCount(modSrc, modIdx);
          
          const modDesc = api.modDescription(modSrc, modIdx);
          
          // Split database description by newlines to get individual lines
          const dbLines = modDesc.split('\n').map(line => line.trim()).filter(line => line);
          
          // Only match if number of lines matches
          if (dbLines.length !== parsedMod.descriptions.length) {
            // Debug: log when line counts don't match for first few
            if (i < 2) {
              console.log(`    Skipping (${dbLines.length} lines): ${modDesc.substring(0, 50)}...`);
            }
            continue;
          }
          
          // Try to match ALL lines
          let allLinesMatch = true;
          for (let lineIdx = 0; lineIdx < parsedMod.descriptions.length; lineIdx++) {
            const parsedLine = parsedMod.descriptions[lineIdx];
            const dbLine = dbLines[lineIdx];
            
            // Normalize both lines
            const normalizedParsed = parsedLine
              .replace(/\([^)]+\)/g, '')  // Remove parentheses with ranges
              .replace(/[\d\.\-\+%]+/g, '#')  // Replace numbers with #
              .replace(/#/g, '')  // Remove all # symbols
              .replace(/\s+/g, ' ')
              .trim()
              .toLowerCase();
            
            const normalizedDb = dbLine
              .replace(/[\d\.\-\+%]+/g, '#')
              .replace(/#/g, '')
              .replace(/\s+/g, ' ')
              .trim()
              .toLowerCase();
            
            if (normalizedParsed !== normalizedDb) {
              allLinesMatch = false;
              // Debug first mismatch
              if (i < 2) {
                console.log(`    Line ${lineIdx} mismatch: "${normalizedParsed}" vs "${normalizedDb}"`);
              }
              break;
            }
          }
          
          if (allLinesMatch) {
            console.log(`  ‚úì Matched by description (all ${parsedMod.descriptions.length} lines) to modifier ${modIdx}:`, modDesc);
            
            // If we have a tier name from POE2, try to match it to a tier in this modifier
            // Tier name matching is especially important for essence/desecrated modifiers
            let tierNameMatch = -1;
            if (parsedMod.tierName) {
              for (let t = 0; t < tierCount; t++) {
                const dbTierName = api.modTierName(modSrc, modIdx, t);
                if (dbTierName === parsedMod.tierName) {
                  tierNameMatch = t;
                  console.log(`  ‚úì Tier name "${parsedMod.tierName}" matched to tier index ${t}`);
                  break;
                }
              }
              
              // If tier name doesn't match for essence/desecrated modifiers, skip this modifier
              // (This prevents matching essence modifiers to normal modifiers with same description)
              // But for normal modifiers, tier names often differ, so we allow description-only matching
              if (tierNameMatch === -1 && (modSrc === 1 || modSrc === 2 || parsedMod.tierName.includes('Essence'))) {
                console.log(`  ‚úó Tier name "${parsedMod.tierName}" not found in this modifier's tiers, skipping essence/desecrated...`);
                continue;
              } else if (tierNameMatch === -1) {
                console.log(`  ‚ö† Tier name "${parsedMod.tierName}" not found, will use tier number instead`);
              }
            }
            
            const key = `${modSrc}_${modIdx}`;
            
            // Use tier name match if found, otherwise use tier number mapping
            let selectedTier;
            if (tierNameMatch >= 0) {
              selectedTier = tierNameMatch;
              console.log(`  Using tier from name match: index ${selectedTier}`);
            } else {
              // Map POE2 tier to our tier system
              // POE2: Tier 1 = BEST tier, Tier 2 = second best, etc. (counting from top)
              // Our system: Tier 0 = WORST, Tier 1 = second worst, ..., Tier N-1 = BEST (counting from bottom)
              // Formula: our_tier = tierCount - poe2_tier
              // Example: If tierCount=8 and POE2 shows Tier 2, then our_tier = 8-2 = 6 (second from top)
              selectedTier = tierCount - 1; // Default to best tier
              if (parsedMod.tier && parsedMod.tier > 0 && parsedMod.tier <= tierCount) {
                selectedTier = tierCount - parsedMod.tier;
              }
              console.log(`  Tier mapping: POE2 T${parsedMod.tier} ‚Üí Our index ${selectedTier} (out of ${tierCount} tiers, 0=worst)`);
            }
            
            return {
              key: key,
              source: modSrc,
              index: modIdx,
              description: modDesc,
              tierCount: tierCount,
              selectedTier: selectedTier
            };
          }
        }
      }
      
      console.log(`  ‚úó No match found`);
      return null;
    }
    
    function applyImportedItem(itemId, rarity, matchedModifiers, parsedModifiers) {
      // Set mode to improve since we're importing an existing item
      currentMode = 'improve';
      currentItemId = itemId;
      currentRarity = rarity;
      
      // Update UI to show the selected item
      const itemName = findItemNameById(itemId);
      
      // Hide initial selections and show simulator
      modeSelectionBoxes.style.display = 'none';
      selectionSummary.style.display = 'block';
      modeBadge.textContent = 'Improve';
      
      raritySection.style.display = 'none';
      rarityLabelSummary.style.display = 'inline';
      document.getElementById('rarityDropdownInline').style.display = 'inline';
      document.getElementById('rarityDropdownInline').value = rarity;
      document.getElementById('ilvlLabelSummary').style.display = 'inline';
      document.getElementById('ilvlInputInline').style.display = 'inline';
      document.getElementById('ilvlInputInline').value = currentItemLevel;
      
      // Load modifiers
      loadModifiers();
      
      // Set the matched modifiers as existing modifiers
      existingModifiers.prefixes = [...matchedModifiers.prefixes];
      existingModifiers.suffixes = [...matchedModifiers.suffixes];
      selectedModifiers.prefixes = [...matchedModifiers.prefixes];
      selectedModifiers.suffixes = [...matchedModifiers.suffixes];
      
      // Enter expanded mode immediately
      isExpandedMode = true;
      
      // Update UI
      modifiersPanel.style.display = 'flex';
      selectedPanel.style.display = 'flex';
      
      const actionBtn = document.getElementById('actionBtn');
      const stepDescription = document.getElementById('stepDescription');
      
      actionBtn.textContent = 'Calculate Probabilities ‚Üí';
      actionBtn.onclick = finalizeSelection;
      
      const existingCount = existingModifiers.prefixes.length + existingModifiers.suffixes.length;
      const remaining = 6 - existingCount;
      const remainingPrefixes = 3 - existingModifiers.prefixes.length;
      const remainingSuffixes = 3 - existingModifiers.suffixes.length;
      stepDescription.textContent = `Existing modifiers locked. Now add up to ${remaining} more modifiers from all sources (up to ${remainingPrefixes} prefixes, ${remainingSuffixes} suffixes)`;
      
      updateDisplayHeader();
      
      // Check and disable existing modifier checkboxes after a brief delay to ensure DOM is ready
      setTimeout(() => {
        existingModifiers.prefixes.forEach(mod => {
          const checkbox = document.getElementById(`prefix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
            const parent = checkbox.closest('.modifier-item');
            if (parent) {
              parent.classList.add('selected');
              parent.style.opacity = '0.7';
              const dropdown = parent.querySelector('.tier-dropdown');
              if (dropdown) {
                dropdown.style.display = 'block';
                dropdown.value = mod.selectedTier;
                dropdown.id = `prefix_tier_${mod.source}_${mod.index}`;  // Ensure dropdown has correct ID
              }
            }
          }
        });
        
        existingModifiers.suffixes.forEach(mod => {
          const checkbox = document.getElementById(`suffix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
            const parent = checkbox.closest('.modifier-item');
            if (parent) {
              parent.classList.add('selected');
              parent.style.opacity = '0.7';
              const dropdown = parent.querySelector('.tier-dropdown');
              if (dropdown) {
                dropdown.style.display = 'block';
                dropdown.value = mod.selectedTier;
                dropdown.id = `suffix_tier_${mod.source}_${mod.index}`;  // Ensure dropdown has correct ID
              }
            }
          }
        });
        
        updateSelectedDisplay();
        updateModifierCount();
      }, 100);
      
      // Calculate unmatched modifiers for warning message
      const totalParsed = (parsedModifiers?.prefixes?.length || 0) + (parsedModifiers?.suffixes?.length || 0);
      const totalMatched = matchedModifiers.prefixes.length + matchedModifiers.suffixes.length;
      const unmatchedCount = totalParsed - totalMatched;
      
      let message = `Item imported successfully!\n\nItem: ${itemName}\nRarity: ${rarity}\nModifiers: ${matchedModifiers.prefixes.length} prefixes, ${matchedModifiers.suffixes.length} suffixes`;
      
      if (unmatchedCount > 0) {
        message += `\n\n‚ö†Ô∏è Note: ${unmatchedCount} modifier(s) could not be matched.\nThis usually means the database is outdated and missing some modifiers.\nYou can manually select the missing modifiers or calculate with what was imported.`;
      }
      
      message += '\n\nYou can now add more modifiers or calculate probabilities.';
      
      alert(message);
    }
    
    function findItemNameById(itemId) {
      for (const category in ITEM_CATEGORIES) {
        for (const subtype of ITEM_CATEGORIES[category].subtypes) {
          if (subtype.id === itemId) {
            return subtype.name;
          }
        }
      }
      return 'Unknown Item';
    }
    
    function toggleSelectionMode() {
      const actionBtn = document.getElementById('actionBtn');
      const stepDescription = document.getElementById('stepDescription');
      
      if (!isExpandedMode) {
        // Save existing modifiers before expanding
        existingModifiers.prefixes = [...selectedModifiers.prefixes];
        existingModifiers.suffixes = [...selectedModifiers.suffixes];
        
        // Expand to full selection mode
        isExpandedMode = true;
        actionBtn.textContent = 'Calculate Probabilities ‚Üí';
        actionBtn.onclick = finalizeSelection;
        
        const existingCount = existingModifiers.prefixes.length + existingModifiers.suffixes.length;
        const remaining = 6 - existingCount;
        stepDescription.textContent = `Existing modifiers locked. Now add up to ${remaining} more modifiers from all sources (up to ${3 - existingModifiers.prefixes.length} prefixes, ${3 - existingModifiers.suffixes.length} suffixes)`;
        
        // Disable checkboxes for existing modifiers so they can't be deselected
        existingModifiers.prefixes.forEach(mod => {
          const checkbox = document.getElementById(`prefix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.disabled = true;
            checkbox.parentElement.style.opacity = '0.7';
          }
        });
        
        existingModifiers.suffixes.forEach(mod => {
          const checkbox = document.getElementById(`suffix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.disabled = true;
            checkbox.parentElement.style.opacity = '0.7';
          }
        });
        
        // Reload modifiers to show all sources if magic
        if (currentRarity === 'magic') {
          reloadModifiers();
        }
        
        updateModifierCount();
      }
    }
    
    function finalizeSelection() {
      console.log('Final modifiers:', selectedModifiers);
      
      const totalPrefixes = selectedModifiers.prefixes.length;
      const totalSuffixes = selectedModifiers.suffixes.length;
      
      console.log(`Total item: ${totalPrefixes} prefixes, ${totalSuffixes} suffixes`);
      
      // Separate existing modifiers from desired modifiers
      const existingMods = [];
      const desiredMods = [];
      
      const collectModifier = (mod, type) => {
        const dropdown = document.getElementById(`${type}_tier_${mod.source}_${mod.index}`);
        const selectedTier = dropdown ? parseInt(dropdown.value) : 0;
        
        return {
          source: mod.source,
          index: mod.index,
          tier: selectedTier,
          type: type,
          description: mod.description
        };
      };
      
      // Check if each modifier is existing or desired
      selectedModifiers.prefixes.forEach(mod => {
        const isExisting = existingModifiers.prefixes.some(em => em.key === mod.key);
        const modData = collectModifier(mod, 'prefix');
        if (isExisting) {
          existingMods.push(modData);
        } else {
          desiredMods.push(modData);
        }
      });
      
      selectedModifiers.suffixes.forEach(mod => {
        const isExisting = existingModifiers.suffixes.some(em => em.key === mod.key);
        const modData = collectModifier(mod, 'suffix');
        if (isExisting) {
          existingMods.push(modData);
        } else {
          desiredMods.push(modData);
        }
      });
      
      // Collect disabled currencies (blacklist approach)
      const disabledCurrenciesList = [];
      CURRENCIES.forEach(currency => {
        if (!enabledCurrencies.has(currency.id)) {
          disabledCurrenciesList.push(currency.id);
        }
      });
      
      // Collect disabled currency tiers
      const disabledTiersList = Array.from(disabledCurrencyTiers);
      
      // Collect disabled omens
      const disabledOmensList = Array.from(disabledOmens);
      
      // Build complete configuration with modifiers + blacklists
      const completeConfig = {
        itemId: currentItemId,
        itemName: currentItemId !== null ? Module.ccall('get_item_name', 'string', ['number'], [currentItemId]) : null,
        mode: currentMode,
        rarity: currentRarity,
        existingModifiers: existingMods,
        desiredModifiers: desiredMods,
        disabledCurrencies: disabledCurrenciesList,
        disabledCurrencyTiers: disabledTiersList,
        disabledOmens: disabledOmensList
      };
      
      console.log('Complete Configuration:', completeConfig);
      console.log('Complete Configuration JSON:\n', JSON.stringify(completeConfig, null, 2));
      
      // Show summary with blacklist info
      const message = `Item will have ${totalPrefixes} prefixes and ${totalSuffixes} suffixes.\n\n` +
                     `Configuration:\n` +
                     `- Disabled currencies: ${disabledCurrenciesList.length}\n` +
                     `- Disabled tiers: ${disabledTiersList.length}\n` +
                     `- Disabled omens: ${disabledOmensList.length}\n\n` +
                     `Check console (F12) for full configuration JSON.\n` +
                     `Probability calculation will be implemented next!`;
      
      alert(message);
    }
    
    function loadModifiers() {
      if (currentItemId === null || currentItemId === undefined) return;
      
      const sourceValue = modSourceEl.value;
      
      // Only clear modifiers and reset state if NOT in expanded mode
      if (!isExpandedMode) {
        selectedModifiers = { prefixes: [], suffixes: [] };
        existingModifiers = { prefixes: [], suffixes: [] };
        updateSelectedDisplay();
      }
      
      updateModifierCount(); // Update the counter display
      
      // Determine which sources to load
      let sourcesToLoad = [];
      if (sourceValue === 'all') {
        sourcesToLoad = [0, 1, 2]; // Normal, Desecrated, Essence
      } else {
        sourcesToLoad = [parseInt(sourceValue)];
      }
      
      console.log('Loading modifiers for item:', currentItemId, 'sources:', sourcesToLoad);
      
      // Load prefixes from all selected sources
      prefixList.innerHTML = '';
      const seenPrefixes = new Set();
      
      // Use item-specific lookup to filter modifiers by item type
      sourcesToLoad.forEach(source => {
        const prefixCount = api.itemPrefixCount(currentItemId, source);
        console.log('Source', source, 'prefix count for item', currentItemId, ':', prefixCount);
        
        for (let p = 0; p < prefixCount; p++) {
          const modSrc = api.itemPrefixSource(currentItemId, source, p);
          const modIdx = api.itemPrefixIndex(currentItemId, source, p);
          const maxTier = api.itemPrefixMaxTier(currentItemId, source, p);
          const modKey = `${modSrc}_${modIdx}`;
          
          // Skip if we've already added this modifier
          if (seenPrefixes.has(modKey)) continue;
          seenPrefixes.add(modKey);
          
          const modDesc = api.modDescription(modSrc, modIdx);
          const tierCount = api.modTierCount(modSrc, modIdx);
          // Limit tier count if maxTier is set (255 = no limit)
          const effectiveTierCount = maxTier === 255 ? tierCount : Math.min(tierCount, maxTier + 1);
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'modifier-item';
        const checkboxId = `prefix_${modSrc}_${modIdx}`;
        const dropdownId = `prefix_tier_${modSrc}_${modIdx}`;
        
        // Determine source name and class
        let sourceName = '';
        let sourceClass = '';
        if (modSrc === 0) {
          sourceName = 'Normal';
          sourceClass = 'normal-source';
        } else if (modSrc === 1) {
          sourceName = 'Desecrated';
          sourceClass = 'desecrated-source';
        } else if (modSrc === 2) {
          sourceName = 'Essence';
          sourceClass = 'essence-source';
        } else if (modSrc === 3) {
          sourceName = 'Perfect Essence';
          sourceClass = 'essence-source';
        }
        
        // Build tier dropdown options with values (reversed - highest values = T1)
        // Only include tiers where level requirement <= current item level AND tier <= maxTier
        let tierOptions = '';
        let availableTierCount = 0;
        for (let t = effectiveTierCount - 1; t >= 0; t--) {
          const levelReq = api.modTierLevelReq(modSrc, modIdx, t);
          if (levelReq > currentItemLevel) continue; // Skip tiers above item level
          
          availableTierCount++;
          const valueCount = api.modTierValueCount(modSrc, modIdx, t);
          let valueStr = '';
          for (let v = 0; v < valueCount; v++) {
            const min = api.modTierValueMin(modSrc, modIdx, t, v);
            const max = api.modTierValueMax(modSrc, modIdx, t, v);
            if (v > 0) valueStr += ', ';
            if (min === max) {
              valueStr += min;
            } else {
              valueStr += `(${min}-${max})`;
            }
          }
          if (modDesc.includes('Lightning')) console.log(`Lightning mod: valueCount=${valueCount}, valueStr=${valueStr}`);
          tierOptions += `<option value="${t}">T${effectiveTierCount - t}: ${valueStr} (lvl ${levelReq})</option>`;
        }
        
        // Skip this modifier if no tiers are available at current item level
        if (availableTierCount === 0) continue;
        
        const modGroup = api.modGroup(modSrc, modIdx);
        
        itemDiv.innerHTML = `
          <input type="checkbox" id="${checkboxId}">
          <label for="${checkboxId}">${modDesc}</label>
          <div class="modifier-badges">
            <span class="source-badge ${sourceClass}">${sourceName}</span>
            <span class="tier-badge">${effectiveTierCount} tiers</span>
            <span class="family-badge" title="Family: ${modGroup}">${modGroup}</span>
          </div>
          <select class="tier-dropdown" id="${dropdownId}" style="display: none;">
            ${tierOptions}
          </select>
        `;
        
        // Make the entire div clickable except for dropdown
        itemDiv.onclick = function(e) {
          // Don't toggle if clicking on dropdown
          if (e.target.tagName === 'SELECT') return;
          
          e.preventDefault();
          e.stopPropagation();
          
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          toggleModifier('prefix', modSrc, modIdx, checkbox);
        };
        
        // Handle tier dropdown change
        const dropdown = itemDiv.querySelector('select');
        dropdown.onchange = function() {
          updateSelectedDisplay();
        };
        
          prefixList.appendChild(itemDiv);
        }
      });
      
      // Load suffixes from all selected sources
      suffixList.innerHTML = '';
      const seenSuffixes = new Set();
      
      sourcesToLoad.forEach(source => {
        const suffixCount = api.itemSuffixCount(currentItemId, source);
        console.log('Source', source, 'suffix count for item', currentItemId, ':', suffixCount);
        
        for (let s = 0; s < suffixCount; s++) {
          const modSrc = api.itemSuffixSource(currentItemId, source, s);
          const modIdx = api.itemSuffixIndex(currentItemId, source, s);
          const maxTier = api.itemSuffixMaxTier(currentItemId, source, s);
          const modKey = `${modSrc}_${modIdx}`;
          
          // Skip if we've already added this modifier
          if (seenSuffixes.has(modKey)) continue;
          seenSuffixes.add(modKey);
          
          const modDesc = api.modDescription(modSrc, modIdx);
          const tierCount = api.modTierCount(modSrc, modIdx);
          // Limit tier count if maxTier is set (255 = no limit)
          const effectiveTierCount = maxTier === 255 ? tierCount : Math.min(tierCount, maxTier + 1);
        
        const itemDiv = document.createElement('div');
        itemDiv.className = 'modifier-item';
        const checkboxId = `suffix_${modSrc}_${modIdx}`;
        const dropdownId = `suffix_tier_${modSrc}_${modIdx}`;
        
        // Determine source name and class
        let sourceName = '';
        let sourceClass = '';
        if (modSrc === 0) {
          sourceName = 'Normal';
          sourceClass = 'normal-source';
        } else if (modSrc === 1) {
          sourceName = 'Desecrated';
          sourceClass = 'desecrated-source';
        } else if (modSrc === 2) {
          sourceName = 'Essence';
          sourceClass = 'essence-source';
        } else if (modSrc === 3) {
          sourceName = 'Perfect Essence';
          sourceClass = 'essence-source';
        }
        
        // Build tier dropdown options with values (reversed - highest values = T1)
        // Only include tiers where level requirement <= current item level
        let tierOptions = '';
        let availableTierCount = 0;
        for (let t = tierCount - 1; t >= 0; t--) {
          const levelReq = api.modTierLevelReq(modSrc, modIdx, t);
          if (levelReq > currentItemLevel) continue; // Skip tiers above item level
          
          availableTierCount++;
          const valueCount = api.modTierValueCount(modSrc, modIdx, t);
          let valueStr = '';
          for (let v = 0; v < valueCount; v++) {
            const min = api.modTierValueMin(modSrc, modIdx, t, v);
            const max = api.modTierValueMax(modSrc, modIdx, t, v);
            if (v > 0) valueStr += ', ';
            if (min === max) {
              valueStr += min;
            } else {
              valueStr += `(${min}-${max})`;
            }
          }
          tierOptions += `<option value="${t}">T${tierCount - t}: ${valueStr} (lvl ${levelReq})</option>`;
        }
        
        // Skip this modifier if no tiers are available at current item level
        if (availableTierCount === 0) continue;
        
        const modGroup = api.modGroup(modSrc, modIdx);
        
        itemDiv.innerHTML = `
          <input type="checkbox" id="${checkboxId}">
          <label for="${checkboxId}">${modDesc}</label>
          <div class="modifier-badges">
            <span class="source-badge ${sourceClass}">${sourceName}</span>
            <span class="tier-badge">${effectiveTierCount} tiers</span>
            <span class="family-badge" title="Family: ${modGroup}">${modGroup}</span>
          </div>
          <select class="tier-dropdown" id="${dropdownId}" style="display: none;">
            ${tierOptions}
          </select>
        `;
        
        // Make the entire div clickable except for dropdown
        itemDiv.onclick = function(e) {
          // Don't toggle if clicking on dropdown
          if (e.target.tagName === 'SELECT') return;
          
          e.preventDefault();
          e.stopPropagation();
          
          const checkbox = this.querySelector('input[type="checkbox"]');
          checkbox.checked = !checkbox.checked;
          toggleModifier('suffix', modSrc, modIdx, checkbox);
        };
        
        // Handle tier dropdown change
        const dropdown = itemDiv.querySelector('select');
        dropdown.onchange = function() {
          updateSelectedDisplay();
        };
        
          suffixList.appendChild(itemDiv);
        }
      });
      
      filterModifiers();
      updateSelectedDisplay();
      
      // If in expanded mode, re-check and disable existing modifiers
      if (isExpandedMode) {
        existingModifiers.prefixes.forEach(mod => {
          const checkbox = document.getElementById(`prefix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
            const parent = checkbox.closest('.modifier-item');
            if (parent) {
              parent.classList.add('selected');
              parent.style.opacity = '0.7';
              const dropdown = parent.querySelector('.tier-dropdown');
              if (dropdown) dropdown.style.display = 'block';
            }
          }
        });
        
        existingModifiers.suffixes.forEach(mod => {
          const checkbox = document.getElementById(`suffix_${mod.source}_${mod.index}`);
          if (checkbox) {
            checkbox.checked = true;
            checkbox.disabled = true;
            const parent = checkbox.closest('.modifier-item');
            if (parent) {
              parent.classList.add('selected');
              parent.style.opacity = '0.7';
              const dropdown = parent.querySelector('.tier-dropdown');
              if (dropdown) dropdown.style.display = 'block';
            }
          }
        });
      }
    }
    
    function filterModifiers() {
      const filterType = modTypeEl.value;
      const prefixContainer = prefixList.parentElement;
      const suffixContainer = suffixList.parentElement;
      
      if (filterType === 'all') {
        prefixContainer.style.display = 'block';
        suffixContainer.style.display = 'block';
      } else if (filterType === 'prefix') {
        prefixContainer.style.display = 'block';
        suffixContainer.style.display = 'none';
      } else if (filterType === 'suffix') {
        prefixContainer.style.display = 'none';
        suffixContainer.style.display = 'block';
      }
    }
    
    function reloadModifiers() {
      loadModifiers();
    }
    
    function toggleModifier(type, source, index, checkbox) {
      const key = `${source}_${index}`;
      const array = type === 'prefix' ? selectedModifiers.prefixes : selectedModifiers.suffixes;
      const idx = array.findIndex(m => m.key === key);
      
      const parent = checkbox.closest('.modifier-item');
      const dropdown = parent.querySelector('.tier-dropdown');
      
      if (idx >= 0) {
        // In expanded mode, don't allow deselection of existing modifiers
        if (isExpandedMode) {
          const existingArray = type === 'prefix' ? existingModifiers.prefixes : existingModifiers.suffixes;
          const isExisting = existingArray.some(m => m.key === key);
          if (isExisting) {
            checkbox.checked = true; // Keep it checked
            return;
          }
        }
        
        // Deselect
        array.splice(idx, 1);
        parent.classList.remove('selected');
        dropdown.style.display = 'none';
      } else {
        // If selecting an essence (source === 2), deselect any other essence first
        if (source === 2) {
          const existingEssenceIdx = array.findIndex(m => m.source === 2);
          if (existingEssenceIdx >= 0) {
            const existingEssence = array[existingEssenceIdx];
            array.splice(existingEssenceIdx, 1);
            
            // Uncheck the previous essence checkbox and hide its dropdown
            const checkboxId = `${type}_${existingEssence.source}_${existingEssence.index}`;
            const existingCheckbox = document.getElementById(checkboxId);
            if (existingCheckbox) {
              existingCheckbox.checked = false;
              const existingParent = existingCheckbox.closest('.modifier-item');
              existingParent.classList.remove('selected');
              const existingDropdown = existingParent.querySelector('.tier-dropdown');
              existingDropdown.style.display = 'none';
            }
          }
        }
        
        // If selecting a desecrated (source === 1), deselect any other desecrated first
        if (source === 1) {
          const existingDesecratedIdx = array.findIndex(m => m.source === 1);
          if (existingDesecratedIdx >= 0) {
            const existingDesecrated = array[existingDesecratedIdx];
            array.splice(existingDesecratedIdx, 1);
            
            // Uncheck the previous desecrated checkbox and hide its dropdown
            const checkboxId = `${type}_${existingDesecrated.source}_${existingDesecrated.index}`;
            const existingCheckbox = document.getElementById(checkboxId);
            if (existingCheckbox) {
              existingCheckbox.checked = false;
              const existingParent = existingCheckbox.closest('.modifier-item');
              existingParent.classList.remove('selected');
              const existingDropdown = existingParent.querySelector('.tier-dropdown');
              existingDropdown.style.display = 'none';
            }
          }
        }
        
        // Check for modifier family conflicts
        // Get the family/group name for this modifier
        const modGroup = api.modGroup(source, index);
        
        // Check if any selected modifier has the same family
        const existingFamilyIdx = array.findIndex(m => {
          const existingGroup = api.modGroup(m.source, m.index);
          return existingGroup === modGroup;
        });
        
        if (existingFamilyIdx >= 0) {
          // Deselect the existing modifier from same family
          const existingMod = array[existingFamilyIdx];
          array.splice(existingFamilyIdx, 1);
          
          // Uncheck the previous modifier and hide its dropdown
          const checkboxId = `${type}_${existingMod.source}_${existingMod.index}`;
          const existingCheckbox = document.getElementById(checkboxId);
          if (existingCheckbox) {
            existingCheckbox.checked = false;
            const existingParent = existingCheckbox.closest('.modifier-item');
            existingParent.classList.remove('selected');
            const existingDropdown = existingParent.querySelector('.tier-dropdown');
            existingDropdown.style.display = 'none';
          }
        }
        
        // Check rarity-specific restrictions
        if (currentRarity === 'magic' && !isExpandedMode) {
          // Magic items in initial mode: only Normal modifiers, max 1 prefix and 1 suffix
          if (source !== 0) {
            checkbox.checked = false;
            return;
          }
          if (array.length >= 1) {
            checkbox.checked = false;
            return;
          }
        } else {
          // Rare items: always enforce max 3 prefixes and 3 suffixes
          if (array.length >= 3) {
            checkbox.checked = false;
            return;
          }
        }
        
        // Select
        const modDesc = api.modDescription(source, index);
        const tierCount = api.modTierCount(source, index);
        array.push({ key, source, index, type, description: modDesc, tierCount });
        parent.classList.add('selected');
        dropdown.style.display = 'block';
      }
      
      updateSelectedDisplay();
      updateModifierCount();
    }
    
    function updateSelectedDisplay() {
      if (selectedModifiers.prefixes.length === 0 && selectedModifiers.suffixes.length === 0) {
        selectedOutput.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">üì¶</div>
            <div>No modifiers selected</div>
          </div>
        `;
        return;
      }
      
      let output = '<div class="selected-list">';
      
      // Show existing modifiers section if in expanded mode
      if (isExpandedMode && (existingModifiers.prefixes.length > 0 || existingModifiers.suffixes.length > 0)) {
        output += '<div style="font-weight: 600; color: #4a9eff; font-size: 0.75rem; margin-bottom: 0.5rem;">EXISTING MODIFIERS (LOCKED)</div>';
      }
      
      // Show additional modifiers section header if in expanded mode
      const additionalPrefixes = isExpandedMode ? selectedModifiers.prefixes.filter(m => 
        !existingModifiers.prefixes.some(em => em.key === m.key)
      ) : [];
      const additionalSuffixes = isExpandedMode ? selectedModifiers.suffixes.filter(m => 
        !existingModifiers.suffixes.some(em => em.key === m.key)
      ) : [];
      
      const hasAdditional = additionalPrefixes.length > 0 || additionalSuffixes.length > 0;
      
      // Prefixes section
      if (selectedModifiers.prefixes.length > 0 || (isExpandedMode && existingModifiers.prefixes.length > 0)) {
        output += '<div><div class="selected-group-title">Prefixes</div>';
        
        // Show existing prefixes
        if (isExpandedMode && existingModifiers.prefixes.length > 0) {
          existingModifiers.prefixes.forEach(mod => {
            const dropdown = document.getElementById(`prefix_tier_${mod.source}_${mod.index}`);
            const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
            
            const tName = api.modTierName(mod.source, mod.index, selectedTier);
            const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
            const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
            const tierNum = mod.tierCount - selectedTier;
            
            const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
            let valueRange = '';
            for (let v = 0; v < valueCount; v++) {
              const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
              const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
              if (v > 0) valueRange += ', ';
              if (min === max) {
                valueRange += min;
              } else {
                valueRange += `(${min}-${max})`;
              }
            }
            
            output += `
              <div class="selected-mod" style="opacity: 0.9; border-left: 3px solid #4a9eff; padding-left: 0.5rem;">
                <div class="selected-mod-desc">${mod.description}</div>
                <div class="selected-mod-tier">
                  <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
                </div>
              </div>
            `;
          });
        }
        
        // Show separator if we have both existing and additional
        if (isExpandedMode && existingModifiers.prefixes.length > 0 && additionalPrefixes.length > 0) {
          output += '<div style="font-size: 0.7rem; color: #888; font-style: italic; margin: 0.5rem 0;">+ Additional:</div>';
        }
        
        // Show additional prefixes or all prefixes if not in expanded mode
        const prefixesToShow = isExpandedMode ? additionalPrefixes : selectedModifiers.prefixes;
        prefixesToShow.forEach(mod => {
          const dropdown = document.getElementById(`prefix_tier_${mod.source}_${mod.index}`);
          const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
          
          const tName = api.modTierName(mod.source, mod.index, selectedTier);
          const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
          const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
          const tierNum = mod.tierCount - selectedTier;
          
          const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
          let valueRange = '';
          for (let v = 0; v < valueCount; v++) {
            const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
            const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
            if (v > 0) valueRange += ', ';
            if (min === max) {
              valueRange += min;
            } else {
              valueRange += `(${min}-${max})`;
            }
          }
          
          output += `
            <div class="selected-mod">
              <div class="selected-mod-desc">${mod.description}</div>
              <div class="selected-mod-tier">
                <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
              </div>
            </div>
          `;
        });
        
        output += '</div>';
      }
      
      // Suffixes section
      if (selectedModifiers.suffixes.length > 0 || (isExpandedMode && existingModifiers.suffixes.length > 0)) {
        output += '<div><div class="selected-group-title">Suffixes</div>';
        
        // Show existing suffixes
        if (isExpandedMode && existingModifiers.suffixes.length > 0) {
          existingModifiers.suffixes.forEach(mod => {
            const dropdown = document.getElementById(`suffix_tier_${mod.source}_${mod.index}`);
            const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
            
            const tName = api.modTierName(mod.source, mod.index, selectedTier);
            const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
            const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
            const tierNum = mod.tierCount - selectedTier;
            
            const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
            let valueRange = '';
            for (let v = 0; v < valueCount; v++) {
              const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
              const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
              if (v > 0) valueRange += ', ';
              if (min === max) {
                valueRange += min;
              } else {
                valueRange += `(${min}-${max})`;
              }
            }
            
            output += `
              <div class="selected-mod" style="opacity: 0.9; border-left: 3px solid #4a9eff; padding-left: 0.5rem;">
                <div class="selected-mod-desc">${mod.description}</div>
                <div class="selected-mod-tier">
                  <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
                </div>
              </div>
            `;
          });
        }
        
        // Show separator if we have both existing and additional
        if (isExpandedMode && existingModifiers.suffixes.length > 0 && additionalSuffixes.length > 0) {
          output += '<div style="font-size: 0.7rem; color: #888; font-style: italic; margin: 0.5rem 0;">+ Additional:</div>';
        }
        
        // Show additional suffixes or all suffixes if not in expanded mode
        const suffixesToShow = isExpandedMode ? additionalSuffixes : selectedModifiers.suffixes;
        suffixesToShow.forEach(mod => {
          const dropdown = document.getElementById(`suffix_tier_${mod.source}_${mod.index}`);
          const selectedTier = dropdown ? parseInt(dropdown.value) : mod.tierCount - 1;
          
          const tName = api.modTierName(mod.source, mod.index, selectedTier);
          const tLvl = api.modTierLevelReq(mod.source, mod.index, selectedTier);
          const tWeight = api.modTierWeight(mod.source, mod.index, selectedTier);
          const tierNum = mod.tierCount - selectedTier;
          
          const valueCount = api.modTierValueCount(mod.source, mod.index, selectedTier);
          let valueRange = '';
          for (let v = 0; v < valueCount; v++) {
            const min = api.modTierValueMin(mod.source, mod.index, selectedTier, v);
            const max = api.modTierValueMax(mod.source, mod.index, selectedTier, v);
            if (v > 0) valueRange += ', ';
            if (min === max) {
              valueRange += min;
            } else {
              valueRange += `(${min}-${max})`;
            }
          }
          
          output += `
            <div class="selected-mod">
              <div class="selected-mod-desc">${mod.description}</div>
              <div class="selected-mod-tier">
                <span class="tier-name">T${tierNum}</span> ${tName} (${valueRange}) ‚Ä¢ lvl ${tLvl} ‚Ä¢ weight ${tWeight}
              </div>
            </div>
          `;
        });
        
        output += '</div>';
      }
      
      output += '</div>';
      selectedOutput.innerHTML = output;
    }
  </script>
</body>
</html>
